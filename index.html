<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDEN - Sales Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
<script>
// Real-time: populate Stores and Products selects directly from Firebase
function populateSelectsRealtime(){
  const storeSel = document.getElementById('storeName');
  const prodSel = document.getElementById('product');
  if (!window.database || !storeSel || !prodSel) return;

  window.database.ref('stores').on('value', snap => {
    if (!storeSel) return;
    storeSel.length = 1; // keep placeholder
    if (!snap.exists()) return;
    snap.forEach(child => {
      const s = child.val() || {};
      const opt = document.createElement('option');
      opt.value = s.name || s.storeName || child.key;
      opt.textContent = s.name || s.storeName || child.key;
      storeSel.appendChild(opt);
    });
  });

    window.database.ref('products').on('value', snap => {
    if (!prodSel) return;
    prodSel.length = 1; // keep placeholder
    // reset index
    window.productIndex = {};
    if (!snap.exists()) return;
    snap.forEach(child => {
      const p = child.val() || {};
      const opt = document.createElement('option');
      opt.value = p.name || p.productName || child.key;
      opt.textContent = p.name || p.productName || child.key;
      prodSel.appendChild(opt);
      const price = typeof p.price === 'string' ? parseFloat(p.price) : (p.price || 0);
      window.productIndex[opt.value] = { key: child.key, price };
    });
  });
}

</script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700;800;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;800;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            letter-spacing: -0.01em;
            background: #0a0a0a;
            overflow-x: hidden;
        }
        
        .premium-bg {
            background: radial-gradient(ellipse at top, #1a1a2e 0%, #16213e 25%, #0f0f23 50%, #000000 100%);
            position: relative;
        }
        
        .premium-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 226, 0.1) 0%, transparent 50%);
            animation: gradientShift 20s ease-in-out infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .glass-morphism {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                inset 0 -1px 0 rgba(255, 255, 255, 0.05);
        }
        
        .premium-shadow {
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.4),
                0 8px 25px rgba(0, 0, 0, 0.3),
                0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .luxury-gradient {
            background: linear-gradient(135deg, 
                #667eea 0%, 
                #764ba2 25%, 
                #f093fb 50%, 
                #f5576c 75%, 
                #4facfe 100%);
            background-size: 400% 400%;
            animation: luxuryShimmer 8s ease-in-out infinite;
        }
        
        @keyframes luxuryShimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .eden-logo {
            background: linear-gradient(135deg, #00f5a0 0%, #00d9f5 100%);
            position: relative;
            overflow: hidden;
        }
        
        .eden-logo::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: logoShine 3s ease-in-out infinite;
        }
        
        @keyframes logoShine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
            100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        }
        
        .fade-in { 
            animation: fadeIn 1.2s cubic-bezier(0.16, 1, 0.3, 1); 
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(60px) scale(0.95);
                filter: blur(10px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1);
                filter: blur(0);
            }
        }
        
        .slide-up { 
            animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1); 
        }
        
        @keyframes slideUp {
            from { 
                transform: translateY(120px) scale(0.9);
                opacity: 0;
                filter: blur(20px);
            }
            to { 
                transform: translateY(0) scale(1);
                opacity: 1;
                filter: blur(0);
            }
        }
        
        .pulse-error { 
            animation: pulseError 0.6s cubic-bezier(0.16, 1, 0.3, 1); 
        }
        
        @keyframes pulseError {
            0% { transform: scale(1); }
            30% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .premium-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 
                0 8px 30px rgba(102, 126, 234, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .premium-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.6s;
        }
        
        .premium-button:hover::before {
            left: 100%;
        }
        
        .premium-button:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 
                0 15px 40px rgba(102, 126, 234, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        
        .premium-input {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #ffffff;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        .premium-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .premium-input:focus {
            background: rgba(255, 255, 255, 0.12);
            border-color: #667eea;
            box-shadow: 
                0 0 0 3px rgba(102, 126, 234, 0.2),
                0 8px 25px rgba(0, 0, 0, 0.3);
            transform: translateY(-1px);
        }
        
        /* Dropdown option styling */
        .premium-input option {
            background: #1a1a2e;
            color: #ffffff;
            padding: 12px;
            border: none;
        }
        
        .premium-input option:hover {
            background: #667eea;
            color: #ffffff;
        }
        
        .premium-input option:checked {
            background: #667eea;
            color: #ffffff;
        }
        
        .floating-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }
        
        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: float 20s infinite linear;
        }
        
        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }
        
        .premium-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
        }
        
        .premium-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        }
        
        .premium-card:hover {
            transform: translateY(-5px);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .text-gradient {
            background: linear-gradient(135deg, #ffffff 0%, #a0a0a0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .text-premium {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .glow-effect {
            position: relative;
        }
        
        .glow-effect::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.3) 0%, transparent 70%);
            transform: translate(-50%, -50%);
            z-index: -1;
            animation: glow 4s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { opacity: 0.5; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
        }
        
        .luxury-header {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .stat-card:hover::before {
            opacity: 1;
        }
        
        .stat-card:hover {
            transform: translateY(-3px) scale(1.02);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }
        
        .premium-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .premium-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }
        
        .premium-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        
        .premium-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .eden-logo {
                width: 20px;
                height: 20px;
            }
            
            .eden-logo svg {
                width: 12px;
                height: 12px;
            }
            
            .luxury-header {
                padding: 16px 0;
            }
            
            .luxury-header .max-w-md,
            .luxury-header .max-w-6xl {
                padding: 0 16px;
            }
            
            .premium-card {
                margin: 16px;
                padding: 24px;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .premium-input {
                padding: 16px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .premium-button {
                padding: 16px 24px;
                font-size: 16px;
            }
            
            /* Touch-friendly buttons */
            button, .premium-button {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Better mobile table */
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
            }
            
            /* Mobile modal adjustments */
            #modalOverlay .premium-card,
            #productModalOverlay .premium-card {
                margin: 20px;
                max-height: calc(100vh - 40px);
            }
        }
        
        /* Very small screens */
        @media (max-width: 480px) {
            .text-6xl {
                font-size: 3rem;
            }
            
            .text-2xl {
                font-size: 1.5rem;
            }
            
            .grid-cols-2 {
                grid-template-columns: 1fr;
            }
            
            .grid-cols-3 {
                grid-template-columns: 1fr;
            }
            
            .space-x-4 > * + * {
                margin-left: 0.5rem;
            }
            
            .space-x-6 > * + * {
                margin-left: 0.75rem;
            }
        }
        
        /* Landscape mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .min-h-screen {
                min-height: 100vh;
            }
            
            .premium-card {
                padding: 16px;
            }
        }
    
/* Hide any status chips inside Employee Management action area */
#employeesManagement .space-x-3 > span { display: none !important; }
</style>
</head>

<script>
    // --- Eden: single-run guard to prevent duplicate event listeners ---
    (function(){
      if (window.__edenInitDone) return;
      window.__edenInitDone = true;
    })();
    </script>

    <!-- Floating Particles -->
    <div class="floating-particles">
        <div class="particle" style="left: 10%; animation-delay: 0s;"></div>
        <div class="particle" style="left: 20%; animation-delay: 2s;"></div>
        <div class="particle" style="left: 30%; animation-delay: 4s;"></div>
        <div class="particle" style="left: 40%; animation-delay: 6s;"></div>
        <div class="particle" style="left: 50%; animation-delay: 8s;"></div>
        <div class="particle" style="left: 60%; animation-delay: 10s;"></div>
        <div class="particle" style="left: 70%; animation-delay: 12s;"></div>
        <div class="particle" style="left: 80%; animation-delay: 14s;"></div>
        <div class="particle" style="left: 90%; animation-delay: 16s;"></div>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-6 relative z-10">
        <div class="max-w-sm w-full">
            <!-- EDEN Logo -->
            <div class="text-center mb-16 fade-in">
                <h1 class="text-6xl font-black text-gradient mb-4" style="font-family: 'Playfair Display', serif; letter-spacing: -0.02em;">EDEN</h1>
                <p class="text-white/70 text-xl font-light tracking-wide">Sales Management System</p>

                <div class="flex items-center justify-center space-x-2 mt-4">
                    <div class="flex items-center space-x-1" id="loginSyncStatus">
                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                        <span class="text-xs text-green-400 font-medium">SYNCED</span>
                    </div>
                </div>
                <div class="w-16 h-0.5 bg-gradient-to-r from-transparent via-white/30 to-transparent mx-auto mt-6"></div>
            </div>

            <!-- Login Form -->
            <div class="glass-morphism rounded-3xl premium-shadow p-10 slide-up">
                <form id="loginForm" class="space-y-8">
                    <!-- Username Input -->
                    <div>
                        <label class="block text-sm font-semibold text-white/90 mb-4 tracking-wide">USERNAME</label>
                        <input type="text" id="username" required 
                               class="premium-input w-full px-6 py-5 text-lg rounded-2xl focus:outline-none font-medium"
                               placeholder="Enter your username">
                    </div>

                    <!-- Password Input -->
                    <div>
                        <label class="block text-sm font-semibold text-white/90 mb-4 tracking-wide">PASSWORD</label>
                        <div class="relative">
                            <input type="password" id="password" required 
                                   class="premium-input w-full px-6 py-5 text-lg rounded-2xl focus:outline-none pr-14 font-medium"
                                   placeholder="Enter your password">
                            <button type="button" onclick="togglePassword()" 
                                    class="absolute right-5 top-1/2 transform -translate-y-1/2 text-white/50 hover:text-white/80 transition-colors">
                                <svg id="eyeIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Error Message -->
                    <div id="errorMessage" class="hidden bg-red-500/10 border border-red-500/20 text-red-300 px-6 py-4 rounded-2xl text-sm backdrop-blur-sm">
                        <span id="errorText"></span>
                    </div>

                    <!-- Success Message -->
                    <div id="successMessage" class="hidden bg-green-500/10 border border-green-500/20 text-green-300 px-6 py-4 rounded-2xl text-sm backdrop-blur-sm">
                        <span id="successText"></span>
                    </div>

                    <!-- Login Button -->
                    <button type="submit" id="loginBtn" 
                            class="premium-button w-full text-white py-5 px-8 font-bold text-lg rounded-2xl disabled:opacity-50 disabled:cursor-not-allowed tracking-wide">
                        <span id="loginBtnText">SIGN IN</span>
                        <span id="loginSpinner" class="hidden flex items-center justify-center">
                            <svg class="animate-spin -ml-1 mr-3 h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            SIGNING IN...
                        </span>
                    </button>

                    <!-- Developer Info -->
                    <div class="text-center text-xs text-white/40 mt-4">
                        Developed by SUAFIJ â€¢ mksufaij0@gmail.com â€¢ +919961296000
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sales Entry Page (Employee) -->
    <div id="salesPage" class="hidden min-h-screen premium-bg">
        <!-- Header -->
        <header class="luxury-header sticky top-0 z-50">
            <div class="max-w-md mx-auto px-6 py-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="eden-logo w-10 h-10 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C10.9 2 10 2.9 10 4V6H8C6.9 6 6 6.9 6 8V20C6 21.1 6.9 22 8 22H16C17.1 22 18 21.1 18 20V8C18 6.9 17.1 6 16 6H14V4C14 2.9 13.1 2 12 2ZM12 4V6H12V4ZM8 8H16V20H8V8ZM10 10V18H14V10H10ZM11 11H13V17H11V11Z"/>
                                <circle cx="12" cy="5" r="1"/>
                                <path d="M9 9H15V10H9V9Z"/>
                            </svg>
                        </div>
                        <div>
                            <div class="flex items-center space-x-3">
                                <h1 class="text-xl font-bold text-white">EDEN Sales</h1>
                                <div class="flex flex-col items-start">
                                    <div class="flex items-center space-x-1" id="syncStatus">
                                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                        <span class="text-xs text-green-400 font-medium">SYNCED</span>
                                    </div>
                                    <div class="text-xs text-white/40" id="lastSyncTime">Last sync: Never</div>
                                </div>
                            </div>
                            <p class="text-sm text-white/60" id="employeeName">Welcome, Employee</p>
                            <p class="text-xs text-white/40" id="salesDateTime">Loading...</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-6">
                        <button onclick="logout()" class="text-red-400 hover:text-red-300 text-sm font-medium transition-colors">
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-md mx-auto p-6 premium-scrollbar">
            <!-- Quick Stats -->
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="stat-card rounded-2xl p-6">
                    <div class="text-sm text-white/60 font-medium tracking-wide">TODAY'S SALES</div>
                    <div class="text-3xl font-black text-premium mt-2" id="todaySalesAmount">0 DHS</div>
                </div>
                <div class="stat-card rounded-2xl p-6">
                    <div class="text-sm text-white/60 font-medium tracking-wide">TODAY'S QTY SOLD</div>
                    <div class="text-3xl font-black text-premium mt-2" id="todayQtyCount">0</div>
                </div>
            </div>

            <!-- Sales Entry Form -->
            <div class="premium-card rounded-3xl p-8 mb-8">
                <h2 class="text-2xl font-bold text-white mb-8 tracking-wide">NEW SALE ENTRY</h2>
                
                <form id="salesForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold text-white/90 mb-3 tracking-wide">STORE NAME</label>
                        <select id="storeName" required onchange="updateProductPrice()"
                                class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium">
    <option value="">Select store</option>
</select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-white/90 mb-3 tracking-wide">PRODUCT</label>
                        <select id="product" required onchange="updateProductPrice()"
                                class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium">
    <option value="">Select product</option>
</select>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-white/90 mb-3 tracking-wide">QTY</label>
                            <input type="number" id="quantity" required min="1"
                                   class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium"
                                   placeholder="1" oninput="updateTotalAmount()">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-white/90 mb-3 tracking-wide">UNIT PRICE</label>
                            <input type="number" id="unitPrice" readonly step="0.01" min="0"
                                   class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium bg-white/5 cursor-not-allowed"
                                   placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-white/90 mb-3 tracking-wide">DATE</label>
                            <input type="date" id="saleDate" required 
                                   class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-white/90 mb-3 tracking-wide">TOTAL AMOUNT</label>
                        <input type="number" id="amount" required step="0.01" min="0" readonly
                               class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium bg-white/5 cursor-not-allowed text-2xl font-bold text-premium"
                               placeholder="0.00">
                    </div>
                    
                    <button type="submit" 
                            class="premium-button w-full text-white py-4 px-8 font-bold rounded-2xl tracking-wide">
                        ðŸ’Ž SAVE SALE
                    </button>
                </form>
            </div>

            <!-- Recent Sales -->
            <div class="premium-card rounded-3xl p-8">
                <h3 class="text-xl font-bold text-white mb-6 tracking-wide">RECENT SALES</h3>
                <div id="recentSalesList" class="space-y-4">
                    <div class="text-white/50 text-center py-8 font-medium">No sales yet today</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminPage" class="hidden min-h-screen premium-bg">
        <!-- Header -->
        <header class="luxury-header sticky top-0 z-50">
            <div class="max-w-6xl mx-auto px-6 py-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="eden-logo w-12 h-12 rounded-xl flex items-center justify-center">
                            <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C10.9 2 10 2.9 10 4V6H8C6.9 6 6 6.9 6 8V20C6 21.1 6.9 22 8 22H16C17.1 22 18 21.1 18 20V8C18 6.9 17.1 6 16 6H14V4C14 2.9 13.1 2 12 2ZM12 4V6H12V4ZM8 8H16V20H8V8ZM10 10V18H14V10H10ZM11 11H13V17H11V11Z"/>
                                <circle cx="12" cy="5" r="1"/>
                                <path d="M9 9H15V10H9V9Z"/>
                            </svg>
                        </div>
                        <div>
                            <div class="flex items-center space-x-3">
                                <h1 class="text-2xl font-bold text-white tracking-wide">EDEN ADMIN</h1>
                                <div class="flex flex-col items-start">
                                    <div class="flex items-center space-x-1" id="adminSyncStatus">
                                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                        <span class="text-xs text-green-400 font-medium">SYNCED</span>
                                    </div>
                                    <div class="text-xs text-white/40" id="adminLastSync">Last sync: Never</div>
                                </div>
                            </div>
                            <p class="text-sm text-white/60" id="adminName">Executive Dashboard</p>
                            <p class="text-xs text-white/40" id="adminDateTime">Loading...</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-6">
                        <button onclick="logout()" class="text-red-400 hover:text-red-300 text-sm font-medium transition-colors">
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-6xl mx-auto p-6 premium-scrollbar">
            <!-- Overview Stats -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                <div class="stat-card rounded-3xl p-8">
                    <div class="text-sm text-white/60 font-medium tracking-wide mb-2">TOTAL SALES</div>
                    <div class="text-4xl font-black text-premium mb-1" id="totalSalesCount">0</div>
                    <div class="text-xs text-white/40">(Yesterday)</div>
                </div>
                <div class="stat-card rounded-3xl p-8">
                    <div class="text-sm text-white/60 font-medium tracking-wide mb-2">REVENUE</div>
                    <div class="text-4xl font-black text-premium mb-1" id="totalRevenue">0 DHS</div>
                    <div class="text-xs text-white/40">(Yesterday)</div>
                </div>
                <div class="stat-card rounded-3xl p-8">
                    <div class="text-sm text-white/60 font-medium tracking-wide mb-2">ACTIVE USERS</div>
                    <div class="text-4xl font-black text-premium mb-1" id="activeUsers">0</div>
                    <div class="text-xs text-white/40">(Yesterday)</div>
                </div>
                <div class="stat-card rounded-3xl p-8">
                    <div class="text-sm text-white/60 font-medium tracking-wide mb-2">AVG. SALE</div>
                    <div class="text-4xl font-black text-premium mb-1" id="avgSaleAmount">0 DHS</div>
                    <div class="text-xs text-white/40">(Yesterday)</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="premium-card rounded-3xl p-8 mb-10">
                <h2 class="text-2xl font-bold text-white mb-8 tracking-wide">QUICK ACTIONS</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <button onclick="showSalesReportPage()" class="premium-button py-6 text-white font-bold rounded-xl text-lg">
                        ðŸ“Š Sales Reports
                    </button>
                    <button onclick="mirrorSyncAllData()" class="premium-button py-6 text-white font-bold rounded-xl text-lg">
                        ðŸ”„ Smart Sync Data
                    </button>
                    <button onclick="downloadMasterData()" class="premium-button py-6 text-white font-bold rounded-xl text-lg">
                        ðŸ“„ Master Data Export
                    </button>
                    <button onclick="downloadSystemBackup()" class="premium-button py-6 text-white font-bold rounded-xl text-lg">
                        ðŸ”„ System Backup
                    </button>
<button onclick="showProductsPage()" class="premium-button py-6 text-white font-bold rounded-xl text-lg">
    ðŸ“¦ Products
</button>
                </div>
            </div>

            <!-- Management Tabs -->
            <div class="premium-card rounded-3xl p-8">
                <div class="flex space-x-1 mb-8 bg-white/5 rounded-2xl p-2">
                    <button onclick="showManagementTab('employees')" id="employeesTab" class="flex-1 py-3 px-4 rounded-xl font-bold text-xs transition-all bg-white/10 text-white">EMPLOYEES</button>
                    <button onclick="showManagementTab('stores')" id="storesTab" class="flex-1 py-3 px-4 rounded-xl font-bold text-xs transition-all text-white/60 hover:text-white">STORES</button>
                    <button onclick="showManagementTab('pricing')" id="pricingTab" class="flex-1 py-3 px-4 rounded-xl font-bold text-xs transition-all text-white/60 hover:text-white">PRICING</button>
                </div>

                <!-- Employees Management -->
<div id="employeesManagement" class="management-section">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-xl font-bold text-white tracking-wide">EMPLOYEE MANAGEMENT</h2>
    <button onclick="showAddEmployeeModal()" class="premium-button px-4 py-2 text-white font-bold rounded-xl text-sm">
      + ADD EMPLOYEE
    </button>
  </div>

  <!-- Dynamic list (populated by your scripts/Firebase). Keep it clean: Name, Role, Edit/Delete only -->
  <div id="employeesList" class="space-y-3 max-h-80 overflow-y-auto premium-scrollbar">
    <div class="text-white/50 text-center py-8 font-medium">Loading employees...</div>
  </div>
</div>
<!-- Stores Management -->
                <div id="storesManagement" class="management-section hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-white tracking-wide">STORE MANAGEMENT</h2>
                        <button onclick="showAddStoreModal()" class="premium-button px-6 py-3 text-white font-bold rounded-xl">+ ADD STORE</button>
                    </div>
                    <div id="storesList" class="space-y-4">
                        <div class="flex items-center justify-between p-6 bg-white/5 rounded-2xl border border-white/10 hover:bg-white/10 transition-all">
                            <div>
                                <div class="font-bold text-white text-lg">Mall of Emirates</div>
                                <div class="text-sm text-white/60">Dubai â€¢ Premium Location</div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="px-4 py-2 bg-green-500/20 text-green-300 rounded-full text-sm font-bold border border-green-500/30">ACTIVE</span>
                                <button onclick="editStore('Mall of Emirates')" class="text-blue-400 hover:text-blue-300 font-medium">Edit</button>
                                <button onclick="deleteStore('Mall of Emirates')" class="text-red-400 hover:text-red-300 font-medium">Delete</button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between p-6 bg-white/5 rounded-2xl border border-white/10 hover:bg-white/10 transition-all">
                            <div>
                                <div class="font-bold text-white text-lg">Dubai Mall</div>
                                <div class="text-sm text-white/60">Dubai â€¢ Flagship Store</div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="px-4 py-2 bg-green-500/20 text-green-300 rounded-full text-sm font-bold border border-green-500/30">ACTIVE</span>
                                <button onclick="editStore('Dubai Mall')" class="text-blue-400 hover:text-blue-300 font-medium">Edit</button>
                                <button onclick="deleteStore('Dubai Mall')" class="text-red-400 hover:text-red-300 font-medium">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- Pricing Management -->
                <div id="pricingManagement" class="management-section hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-white tracking-wide">STORE PRICING MANAGEMENT</h2>
                        <button onclick="showAddPricingModal()" class="premium-button px-6 py-3 text-white font-bold rounded-xl">+ SET STORE PRICE</button>
                    </div>
                    <div class="mb-6">
                        <p class="text-white/70 text-sm">Set custom prices for products in specific stores. If no custom price is set, the default product price will be used.</p>
                    </div>
                    <div id="pricingList" class="space-y-4">
                        <!-- Pricing entries will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Modal Overlay -->
            <div id="modalOverlay" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-6">
                <div class="premium-card rounded-3xl p-8 max-w-md w-full max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 id="modalTitle" class="text-2xl font-bold text-white">Add Item</h3>
                        <button onclick="closeModal()" class="text-white/60 hover:text-white text-2xl">&times;</button>
                    </div>
                    <form id="modalForm" class="space-y-6">
                        <div id="modalFields"></div>
                        <div class="flex space-x-4">
                            <button type="submit" class="premium-button flex-1 py-3 text-white font-bold rounded-xl">SAVE</button>
                            <button type="button" onclick="closeModal()" class="flex-1 py-3 bg-white/10 text-white font-bold rounded-xl hover:bg-white/20 transition-all">CANCEL</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Sales Report Page -->
    <div id="salesReportPage" class="hidden min-h-screen premium-bg">
        <!-- Header -->
        <header class="luxury-header sticky top-0 z-50">
            <div class="max-w-6xl mx-auto px-6 py-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="eden-logo w-12 h-12 rounded-xl flex items-center justify-center">
                            <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C10.9 2 10 2.9 10 4V6H8C6.9 6 6 6.9 6 8V20C6 21.1 6.9 22 8 22H16C17.1 22 18 21.1 18 20V8C18 6.9 17.1 6 16 6H14V4C14 2.9 13.1 2 12 2ZM12 4V6H12V4ZM8 8H16V20H8V8ZM10 10V18H14V10H10ZM11 11H13V17H11V11Z"/>
                                <circle cx="12" cy="5" r="1"/>
                                <path d="M9 9H15V10H9V9Z"/>
                            </svg>
                        </div>
                        <div>
                            <div class="flex items-center space-x-3">
                                <h1 class="text-2xl font-bold text-white tracking-wide">SALES REPORTS</h1>
                                <div class="flex flex-col items-start">
                                    <div class="flex items-center space-x-1" id="reportsSyncStatus">
                                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                        <span class="text-xs text-green-400 font-medium">SYNCED</span>
                                    </div>
                                    <div class="text-xs text-white/40" id="reportsLastSync">Last sync: Never</div>
                                </div>
                            </div>
                            <p class="text-sm text-white/60">Detailed Sales Analytics</p>
                            <p class="text-xs text-white/40" id="reportsDateTime">Loading...</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="quickSyncAllData()" class="text-blue-400 hover:text-blue-300 text-sm font-medium transition-colors flex items-center space-x-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            <span>Quick Sync</span>
                        </button>
                        <button onclick="goBackToDashboard()" class="text-blue-400 hover:text-blue-300 text-sm font-medium transition-colors">
                            Back to Dashboard
                        </button>
                        <button onclick="logout()" class="text-red-400 hover:text-red-300 text-sm font-medium transition-colors">
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-6xl mx-auto p-6 premium-scrollbar">
            <!-- Report Filters -->
            <div class="premium-card rounded-3xl p-8 mb-8">
                <h2 class="text-2xl font-bold text-white mb-8 tracking-wide">REPORT FILTERS</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div>
                        <label class="block text-sm font-semibold text-white/90 mb-3 tracking-wide">FROM DATE</label>
                        <input type="date" id="reportFromDate" 
                               class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-white/90 mb-3 tracking-wide">TO DATE</label>
                        <input type="date" id="reportToDate" 
                               class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-white/90 mb-3 tracking-wide">REPORT TYPE</label>
                        <select id="reportType" 
                                class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium">
                            <option value="all">All Sales</option>
                            <option value="product">Product Wise</option>
                            <option value="store">Store Wise</option>
                            <option value="employee">Employee Wise</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="generateReport()" class="premium-button w-full py-4 text-white font-bold rounded-xl">
                            ðŸ“Š Generate Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- Report Summary -->
            <div id="reportSummary" class="hidden grid grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="stat-card rounded-3xl p-6">
                    <div class="text-sm text-white/60 font-medium tracking-wide">TOTAL SALES</div>
                    <div class="text-3xl font-black text-premium mt-2" id="summaryTotalSales">0</div>
                </div>
                <div class="stat-card rounded-3xl p-6">
                    <div class="text-sm text-white/60 font-medium tracking-wide">TOTAL REVENUE</div>
                    <div class="text-3xl font-black text-premium mt-2" id="summaryTotalRevenue">0 DHS</div>
                </div>
                <div class="stat-card rounded-3xl p-6">
                    <div class="text-sm text-white/60 font-medium tracking-wide">TOTAL QUANTITY</div>
                    <div class="text-3xl font-black text-premium mt-2" id="summaryTotalQty">0</div>
                </div>
                <div class="stat-card rounded-3xl p-6">
                    <div class="text-sm text-white/60 font-medium tracking-wide">AVERAGE SALE</div>
                    <div class="text-3xl font-black text-premium mt-2" id="summaryAvgSale">0 DHS</div>
                </div>
            </div>

            <!-- Report Results -->
            <div id="reportResults" class="hidden premium-card rounded-3xl p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white tracking-wide">REPORT RESULTS</h2>
                    <div class="flex space-x-4">
                        <button onclick="downloadReportCSV()" class="premium-button px-6 py-3 text-white font-bold rounded-xl">
                            ðŸ“„ Download CSV
                        </button>
                        <button onclick="downloadReportPDF()" class="premium-button px-6 py-3 text-white font-bold rounded-xl">
                            ðŸ“‹ Download PDF
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-white">
                        <thead>
                            <tr id="reportTableHeader" class="border-b border-white/20">
                                <!-- Headers will be populated dynamically -->
                            </tr>
                        </thead>
                        <tbody id="reportTableBody" class="divide-y divide-white/10">
                            <!-- Data will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Initial Message -->
            <div id="reportInitialMessage" class="premium-card rounded-3xl p-12 text-center">
                <div class="text-6xl mb-6">ðŸ“Š</div>
                <h3 class="text-2xl font-bold text-white mb-4">Generate Sales Report</h3>
                <p class="text-white/70 text-lg">Select your date range and report type above, then click "Generate Report" to view detailed analytics.</p>
            </div>
        </div>
    </div>

    <!-- Products Page -->
    <div id="productsPage" class="hidden min-h-screen premium-bg">
        <!-- Header -->
        <header class="luxury-header sticky top-0 z-50">
            <div class="max-w-6xl mx-auto px-6 py-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="eden-logo w-12 h-12 rounded-xl flex items-center justify-center">
                            <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C10.9 2 10 2.9 10 4V6H8C6.9 6 6 6.9 6 8V20C6 21.1 6.9 22 8 22H16C17.1 22 18 21.1 18 20V8C18 6.9 17.1 6 16 6H14V4C14 2.9 13.1 2 12 2ZM12 4V6H12V4ZM8 8H16V20H8V8ZM10 10V18H14V10H10ZM11 11H13V17H11V11Z"/>
                                <circle cx="12" cy="5" r="1"/>
                                <path d="M9 9H15V10H9V9Z"/>
                            </svg>
                        </div>
                        <div>
                            <div class="flex items-center space-x-3">
                                <h1 class="text-2xl font-bold text-white tracking-wide">PRODUCTS</h1>
                                <div class="flex flex-col items-start">
                                    <div class="flex items-center space-x-1" id="productsSyncStatus">
                                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                        <span class="text-xs text-green-400 font-medium">SYNCED</span>
                                    </div>
                                    <div class="text-xs text-white/40" id="productsLastSync">Last sync: Never</div>
                                </div>
                            </div>
                            <p class="text-sm text-white/60">Product Management</p>
                            <p class="text-xs text-white/40" id="productsDateTime">Loading...</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="quickSyncAllData()" class="text-blue-400 hover:text-blue-300 text-sm font-medium transition-colors flex items-center space-x-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            <span>Quick Sync</span>
                        </button>
                        <button onclick="goBackToDashboard()" class="text-blue-400 hover:text-blue-300 text-sm font-medium transition-colors">
                            Back to Dashboard
                        </button>
                        <button onclick="logout()" class="text-red-400 hover:text-red-300 text-sm font-medium transition-colors">
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-6xl mx-auto p-6 premium-scrollbar">
            <!-- Products Management -->
            <div class="premium-card rounded-3xl p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-white tracking-wide">Product Catalog</h2>
                    <button onclick="showAddProductModal()" class="premium-button px-6 py-3 text-white font-bold rounded-xl">+ Add Product</button>
                </div>
                <div id="productsPageList" class="space-y-4">
                    <!-- Products will be loaded here -->
                </div>
            </div>

            <!-- Product Modal -->
            <div id="productModalOverlay" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-6">
                <div class="premium-card rounded-3xl p-8 max-w-md w-full max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 id="productModalTitle" class="text-xl font-bold text-white">Add Product</h3>
                        <button onclick="closeProductModal()" class="text-white/60 hover:text-white text-2xl">&times;</button>
                    </div>
                    <form id="productModalForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-white/90 mb-3">Product Name</label>
                            <input type="text" name="productName" required class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium" placeholder="Enter product name">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-white/90 mb-3">Price (DHS)</label>
                            <input type="number" name="price" required step="0.01" min="0" class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium" placeholder="0.00">
                        </div>
                        <div class="flex space-x-4">
                            <button type="submit" class="premium-button flex-1 py-3 text-white font-bold rounded-xl">Save</button>
                            <button type="button" onclick="closeProductModal()" class="flex-1 py-3 bg-white/10 text-white font-bold rounded-xl hover:bg-white/20 transition-all">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration - REAL-TIME ENABLED
        const firebaseConfig = {
  apiKey: "AIzaSyDSBfcSjzYyhrVR3SNcf18UAqS4r_AcbMs",
  authDomain: "eden-sales-9600.firebaseapp.com",
  databaseURL: "https://eden-sales-9600-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "eden-sales-9600",
  storageBucket: "eden-sales-9600.firebasestorage.app",
  messagingSenderId: "631716537385",
  appId: "1:631716537385:web:ee3267b050bcf5d42fa838",
  measurementId: "G-XKZQ34V9TC"
};

        // Real-time Firebase Status
        console.log("ðŸ”¥ Firebase Real-time Database Configuration:");
        console.log("âœ… Database URL:", firebaseConfig.databaseURL);
        console.log("âœ… Project ID:", firebaseConfig.projectId);
        console.log("âœ… Real-time listeners: ENABLED");
        console.log("âœ… Auto-sync: ENABLED");
        console.log("âœ… Connection monitoring: ENABLED");

        /*
        FIREBASE REALTIME DATABASE RULES:
        Copy and paste these rules in Firebase Console > Realtime Database > Rules:

        {
          "rules": {
            ".read": true,
            ".write": true,
            "users": {
              ".indexOn": ["username", "role", "lastActive"]
            },
            "sales": {
              ".indexOn": ["employeeId", "date", "storeName", "product", "timestamp"]
            },
            "products": {
              ".indexOn": ["name", "price"]
            },
            "stores": {
              ".indexOn": ["name", "location", "status"]
            },
            "employees": {
              ".indexOn": ["username", "role", "status", "lastActive"]
            },
            "storePricing": {
              ".indexOn": ["productName", "storeName"]
            }
          }
        }

        SECURITY RULES (For Production):
        Replace the above rules with these for better security:

        {
          "rules": {
            "users": {
              ".read": "auth != null",
              ".write": "auth != null",
              "$uid": {
                ".read": "auth != null && (auth.uid == $uid || root.child('users').child(auth.uid).child('role').val() == 'admin')",
                ".write": "auth != null && (auth.uid == $uid || root.child('users').child(auth.uid).child('role').val() == 'admin')"
              }
            },
            "sales": {
              ".read": "auth != null",
              ".write": "auth != null",
              ".indexOn": ["employeeId", "date", "storeName", "product", "timestamp"]
            },
            "products": {
              ".read": "auth != null",
              ".write": "auth != null && root.child('users').child(auth.uid).child('role').val() == 'admin'",
              ".indexOn": ["name", "price"]
            },
            "stores": {
              ".read": "auth != null",
              ".write": "auth != null && root.child('users').child(auth.uid).child('role').val() == 'admin'",
              ".indexOn": ["name", "location", "status"]
            },
            "employees": {
              ".read": "auth != null && root.child('users').child(auth.uid).child('role').val() == 'admin'",
              ".write": "auth != null && root.child('users').child(auth.uid).child('role').val() == 'admin'",
              ".indexOn": ["username", "role", "status", "lastActive"]
            },
            "storePricing": {
              ".read": "auth != null",
              ".write": "auth != null && root.child('users').child(auth.uid).child('role').val() == 'admin'",
              ".indexOn": ["productName", "storeName"]
            }
          }
        }
        */

        // Initialize Firebase - LIVE MODE
        let isFirebaseConfigured = false;
        let database = null;
        let firebaseDebugInfo = {
            initAttempted: false,
            initSuccess: false,
            connectionTest: false,
            writeTest: false,
            readTest: false,
            errors: [],
            steps: []
        };
        
        // Enhanced Firebase debugging function
        function logFirebaseDebug(step, status, details = null) {
            const timestamp = new Date().toISOString();
            const logMessage = `[${timestamp}] ðŸ”¥ Firebase Debug - ${step}: ${status}`;
            
            console.log(logMessage);
            if (details) {
                console.log("Details:", details);
            }
            
            // Store debug info
            firebaseDebugInfo[step] = { status, details, timestamp };
            firebaseDebugInfo.steps.push({ step, status, details, timestamp });
            
            // Show in UI
            showFirebaseDebugMessage(step, status, details);
        }
        
        function showFirebaseDebugMessage(step, status, details) {
            // Hide all Firebase debug messages from UI
            // All debugging information is still available in browser console
            return;
        }
        
        // Initialize Firebase with real-time capabilities
        try {
            logFirebaseDebug('initAttempted', 'Starting Firebase initialization...');
            
            console.log("ðŸ”¥ Firebase Config Check:", {
                hasApiKey: !!firebaseConfig.apiKey,
                hasAuthDomain: !!firebaseConfig.authDomain,
                hasDatabaseURL: !!firebaseConfig.databaseURL,
                hasProjectId: !!firebaseConfig.projectId,
                apiKeyLength: firebaseConfig.apiKey?.length,
                databaseURL: firebaseConfig.databaseURL,
                fullConfig: firebaseConfig
            });
            
            // Check if Firebase SDK is loaded
            if (typeof firebase === 'undefined') {
                logFirebaseDebug('sdkError', 'Firebase SDK not loaded - scripts may not be loading');
                throw new Error('Firebase SDK not loaded - check script tags');
            }
            
            logFirebaseDebug('sdkCheck', 'Firebase SDK loaded successfully', {
                version: firebase.SDK_VERSION || 'unknown',
                apps: firebase.apps?.length || 0
            });
            
            // Check if app already exists
            if (firebase.apps.length > 0) {
                logFirebaseDebug('appExists', 'Firebase app already initialized, using existing');
                database = firebase.database();
                isFirebaseConfigured = true;
            } else {
                // Initialize Firebase
                logFirebaseDebug('appInit', 'Initializing new Firebase app...');
                const app = firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                isFirebaseConfigured = true;
                
                logFirebaseDebug('initSuccess', 'Firebase app initialized successfully', {
                    appName: app.name,
                    options: app.options
                });
            }
            
            // Test database URL accessibility
            console.log("ðŸ” Testing database URL accessibility...");
            logFirebaseDebug('urlTest', 'Testing database URL: ' + firebaseConfig.databaseURL);
            
            // First, test if we can create a database reference
            try {
                const testRef = database.ref('test');
                logFirebaseDebug('refTest', 'Database reference created successfully');
            } catch (refError) {
                logFirebaseDebug('refError', 'Failed to create database reference', {
                    error: refError.message,
                    code: refError.code
                });
                throw refError;
            }
            
            // Test Firebase connection with enhanced debugging
            database.ref('.info/connected').on('value', (snapshot) => {
                const connected = snapshot.val();
                logFirebaseDebug('connectionTest', connected ? 'Connected to Firebase' : 'Disconnected from Firebase', { 
                    connected,
                    timestamp: new Date().toISOString(),
                    databaseURL: firebaseConfig.databaseURL
                });
                
                if (connected) {
                    console.log("âœ… Firebase connection verified - ONLINE MODE");
                    
                    // Test database rules by attempting a write
                    console.log("ðŸ” Testing database write permissions...");
                    logFirebaseDebug('writeTest', 'Attempting write test...');
                    
                    const testData = {
                        timestamp: new Date().toISOString(),
                        status: 'connected',
                        testId: Math.random().toString(36).substr(2, 9),
                        userAgent: navigator.userAgent.substring(0, 50),
                        url: window.location.href,
                        databaseURL: firebaseConfig.databaseURL,
                        projectId: firebaseConfig.projectId
                    };
                    
                    database.ref('test/connection').set(testData).then(() => {
                        logFirebaseDebug('writeTest', 'Write test successful!', testData);
                        console.log("âœ… Firebase write test successful - Database rules allow writes");
                        
                        // Test read permissions
                        console.log("ðŸ” Testing database read permissions...");
                        logFirebaseDebug('readTest', 'Attempting read test...');
                        
                        return database.ref('test/connection').once('value');
                    }).then((snapshot) => {
                        const readData = snapshot.val();
                        logFirebaseDebug('readTest', 'Read test successful!', readData);
                        console.log("âœ… Firebase read test successful:", readData);
                        console.log("âœ… Database rules allow reads");
                        
                        // Test if we can access the main data paths
                        console.log("ðŸ” Testing main data path access...");
                        logFirebaseDebug('pathTest', 'Testing access to main data paths...');
                        
                        return Promise.all([
                            database.ref('sales').limitToLast(1).once('value'),
                            database.ref('users').limitToLast(1).once('value'),
                            database.ref('products').limitToLast(1).once('value')
                        ]);
                    }).then((snapshots) => {
                        logFirebaseDebug('pathTest', 'Main data paths accessible', {
                            salesExists: snapshots[0].exists(),
                            usersExists: snapshots[1].exists(),
                            productsExists: snapshots[2].exists()
                        });
                        
                        // All tests passed - initialize real-time features
                        logFirebaseDebug('allTests', 'All Firebase tests passed - Going LIVE!');
                        
                        // Initialize real-time listeners
                        initializeRealtimeListeners();
                        // Set up connection monitoring
                        setupConnectionMonitoring();
                        updateSyncStatus('synced');
                        
                        // Load existing data from Firebase
                        loadFirebaseData();
                        populateSelectsRealtime();
                        
                        // Firebase connection successful - no UI notification needed
                        // All connection details are logged to console for debugging
                        
                    }).catch((error) => {
                        logFirebaseDebug('testError', 'Firebase tests failed', {
                            code: error.code,
                            message: error.message,
                            stack: error.stack?.substring(0, 200),
                            name: error.name,
                            details: error.details || 'No additional details'
                        });
                        
                        console.error("âŒ Firebase tests failed:", error);
                        console.error("âŒ Error details:", {
                            code: error.code,
                            message: error.message,
                            name: error.name,
                            details: error.details || 'No additional details'
                        });
                        
                        // Show detailed error message
                        showFirebaseError(error);
                        
                        isFirebaseConfigured = false;
                        updateSyncStatus('error');
                        // initializeDemoData() disabled for cloud-only mode;
                    });
                } else {
                    logFirebaseDebug('connectionError', 'Firebase reports disconnected', { 
                        reason: 'Network issue or Firebase service down',
                        timestamp: new Date().toISOString()
                    });
                    console.log("ðŸ”´ Firebase reports disconnected - Network issue or Firebase down");
                    updateSyncStatus('error');
                }
            }, (error) => {
                logFirebaseDebug('connectionListenerError', 'Connection listener failed', {
                    code: error.code,
                    message: error.message,
                    name: error.name
                });
                console.error("âŒ Firebase connection listener error:", error);
                updateSyncStatus('error');
            });
            
        } catch (error) {
            logFirebaseDebug('initError', 'Firebase initialization failed', {
                code: error.code,
                message: error.message,
                stack: error.stack?.substring(0, 200)
            });
            
            console.error("âŒ Firebase initialization failed:", error);
            console.error("Error details:", {
                code: error.code,
                message: error.message,
                stack: error.stack
            });
            
            showFirebaseError(error);
            
            isFirebaseConfigured = false;
            updateSyncStatus('error');
            // initializeDemoData() disabled for cloud-only mode;
        }
        
        // Debug info display function
        function showFirebaseDebugInfo() {
            console.log("ðŸ” Firebase Debug Summary:", firebaseDebugInfo);
            return firebaseDebugInfo;
        }
        
        // Make debug function available globally
        window.showFirebaseDebugInfo = showFirebaseDebugInfo;
        
        // Function to show user-friendly Firebase error messages
        function showFirebaseError(error) {
            let userMessage = "Firebase connection issue detected. ";
            
            switch(error.code) {
                case 'PERMISSION_DENIED':
                    userMessage += "Database rules are blocking access. Please check Firebase Database Rules.";
                    break;
                case 'NETWORK_ERROR':
                    userMessage += "Network connection problem. Check your internet connection.";
                    break;
                case 'INVALID_TOKEN':
                    userMessage += "Authentication token is invalid. Please check API key.";
                    break;
                default:
                    userMessage += `Error: ${error.message}`;
            }
            
            console.log("ðŸš¨ User-friendly error:", userMessage);
            
            // Hide Firebase error notifications from UI
            // Error details are still logged to console for debugging
        }
        
        // Load existing data from Firebase
        async function loadFirebaseData() {
            if (!isFirebaseConfigured) return;
            
            console.log("ðŸ“¥ Loading existing data from Firebase...");
            
            try {
                // Load all data collections
                const [salesSnap, productsSnap, storesSnap, employeesSnap, pricingSnap, usersSnap] = await Promise.all([
                    database.ref('sales').once('value'),
                    database.ref('products').once('value'),
                    database.ref('stores').once('value'),
                    database.ref('employees').once('value'),
                    database.ref('storePricing').once('value'),
                    database.ref('users').once('value')
                ]);
                
                // Update local data with Firebase data, preserving Firebase keys
                if (salesSnap.exists()) {
                    const firebaseSales = salesSnap.val();
                    salesData = Object.keys(firebaseSales).map(key => ({
                        ...firebaseSales[key],
                        firebaseKey: key
                    }));
                    localStorage.setItem('edenSalesData', JSON.stringify(salesData));
                    console.log(`ðŸ“Š Loaded ${salesData.length} sales records from Firebase`);
                }
                
                if (productsSnap.exists()) {
                    const firebaseProducts = productsSnap.val();
                    productsData = Object.keys(firebaseProducts).map(key => ({
                        ...firebaseProducts[key],
                        firebaseKey: key
                    }));
                    localStorage.setItem('edenProductsData', JSON.stringify(productsData));
                    console.log(`ðŸ“¦ Loaded ${productsData.length} products from Firebase`);
                }
                
                if (storesSnap.exists()) {
                    const firebaseStores = storesSnap.val();
                    storesData = Object.keys(firebaseStores).map(key => ({
                        ...firebaseStores[key],
                        firebaseKey: key
                    }));
                    localStorage.setItem('edenStoresData', JSON.stringify(storesData));
                    console.log(`ðŸª Loaded ${storesData.length} stores from Firebase`);
                }
                
                if (employeesSnap.exists()) {
                    const firebaseEmployees = employeesSnap.val();
                    employeesData = Object.keys(firebaseEmployees).map(key => ({
                        ...firebaseEmployees[key],
                        firebaseKey: key
                    }));
                    localStorage.setItem('edenEmployeesData', JSON.stringify(employeesData));
                    console.log(`ðŸ‘¥ Loaded ${employeesData.length} employees from Firebase`);
                }
                
                if (pricingSnap.exists()) {
                    const firebasePricing = pricingSnap.val();
                    storePricingData = Object.keys(firebasePricing).map(key => ({
                        ...firebasePricing[key],
                        firebaseKey: key
                    }));
                    localStorage.setItem('edenStorePricingData', JSON.stringify(storePricingData));
                    console.log(`ðŸ’° Loaded ${storePricingData.length} custom prices from Firebase`);
                }
                
                if (usersSnap.exists()) {
                    const firebaseUsers = usersSnap.val();
                    // Users are stored by username, so preserve that structure
                    Object.keys(firebaseUsers).forEach(username => {
                        demoUsers[username] = {
                            ...firebaseUsers[username],
                            firebaseKey: username
                        };
                    });
                    console.log(`ðŸ‘¤ Loaded ${Object.keys(firebaseUsers).length} users from Firebase`);
                }
                
                console.log("âœ… All Firebase data loaded successfully");
                
            } catch (error) {
                console.error("âŒ Error loading Firebase data:", error);
                console.log("ðŸ“ Using local demo data instead");
            }
        }

        // Real-time Firebase Functions
        function initializeRealtimeListeners() {
            if (!isFirebaseConfigured) return;
            
            console.log("ðŸ”„ Setting up real-time listeners...");
            
            // Listen for sales data changes
            database.ref('sales').on('value', (snapshot) => {
                const firebaseSales = snapshot.val();
                if (firebaseSales) {
                    salesData = Object.keys(firebaseSales).map(key => ({
                        ...firebaseSales[key],
                        firebaseKey: key
                    }));
                    localStorage.setItem('edenSalesData', JSON.stringify(salesData));
                    console.log(`ðŸ“Š Sales data updated: ${salesData.length} records`);
                    
                    // Update UI if on sales or admin page
                    if (currentUser) {
                        if (currentUser.role === 'admin') {
                            updateAdminStats();
                        } else {
                            updateSalesStats();
                            updateRecentSales();
                        }
                    }
                }
            });
            
            // Listen for products data changes
            database.ref('products').on('value', (snapshot) => {
                const firebaseProducts = snapshot.val();
                if (firebaseProducts) {
                    productsData = Object.keys(firebaseProducts).map(key => ({
                        ...firebaseProducts[key],
                        firebaseKey: key
                    }));
                    localStorage.setItem('edenProductsData', JSON.stringify(productsData));
                    console.log(`ðŸ“¦ Products data updated: ${productsData.length} products`);
                    updateProductsList();
                    refreshCurrentSalesFormPrice();
                }
            });
            
            // Listen for stores data changes
            database.ref('stores').on('value', (snapshot) => {
                const firebaseStores = snapshot.val();
                if (firebaseStores) {
                    storesData = Object.keys(firebaseStores).map(key => ({
                        ...firebaseStores[key],
                        firebaseKey: key
                    }));
                    localStorage.setItem('edenStoresData', JSON.stringify(storesData));
                    console.log(`ðŸª Stores data updated: ${storesData.length} stores`);
                    updateStoresList();
                }
            });
            
            // Listen for employees data changes
            database.ref('employees').on('value', (snapshot) => {
                const firebaseEmployees = snapshot.val();
                if (firebaseEmployees) {
                    employeesData = Object.keys(firebaseEmployees).map(key => ({
                        ...firebaseEmployees[key],
                        firebaseKey: key
                    }));
                    localStorage.setItem('edenEmployeesData', JSON.stringify(employeesData));
                    console.log(`ðŸ‘¥ Employees data updated: ${employeesData.length} employees`);
                    updateEmployeesList();
                }
            });
            
            // Listen for pricing data changes
            database.ref('storePricing').on('value', (snapshot) => {
                const firebasePricing = snapshot.val();
                if (firebasePricing) {
                    storePricingData = Object.keys(firebasePricing).map(key => ({
                        ...firebasePricing[key],
                        firebaseKey: key
                    }));
                    localStorage.setItem('edenStorePricingData', JSON.stringify(storePricingData));
                    console.log(`ðŸ’° Pricing data updated: ${storePricingData.length} custom prices`);
                    updatePricingList();
                    refreshCurrentSalesFormPrice();
                }
            });
            
            // Listen for users data changes
            database.ref('users').on('value', (snapshot) => {
                const firebaseUsers = snapshot.val();
                if (firebaseUsers) {
                    // Update demo users with Firebase data, preserving keys
                    Object.keys(firebaseUsers).forEach(username => {
                        demoUsers[username] = {
                            ...firebaseUsers[username],
                            firebaseKey: username
                        };
                    });
                    console.log(`ðŸ‘¤ Users data updated: ${Object.keys(firebaseUsers).length} users`);
                }
            });
            
            console.log("âœ… Real-time listeners initialized successfully");
        }
        
        // Connection monitoring
        function setupConnectionMonitoring() {
            if (!isFirebaseConfigured) return;
            
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', (snapshot) => {
                if (snapshot.val() === true) {
                    console.log('ðŸŸ¢ Connected to Firebase');
                    updateSyncStatus('synced');
                } else {
                    console.log('ðŸ”´ Disconnected from Firebase');
                    updateSyncStatus('error');
                }
            });
        }
        
        // Initialize demo data if Firebase is not available
        function initializeDemoData() {
            console.log("ðŸ“ Initializing fresh system...");
            
            // Clear existing localStorage and start fresh
            localStorage.removeItem('edenSalesData');
            localStorage.removeItem('edenProductsData');
            localStorage.removeItem('edenStoresData');
            localStorage.removeItem('edenEmployeesData');
            localStorage.removeItem('edenStorePricingData');
            
            // Set empty arrays for fresh start
            localStorage.setItem('edenSalesData', JSON.stringify([]));
            localStorage.setItem('edenProductsData', JSON.stringify([]));
            localStorage.setItem('edenStoresData', JSON.stringify([]));
            localStorage.setItem('edenEmployeesData', JSON.stringify(employeesData)); // Keep only admin
            localStorage.setItem('edenStorePricingData', JSON.stringify([]));
            
            updateSyncStatus('error');
            console.log("âœ… Fresh system initialized - Only admin user remains");
        }
        
        // Save data to Firebase (for new records)
        async function saveToFirebase(path, data) {
            if (!isFirebaseConfigured) {
                console.log("Firebase not configured, saving locally only");
                return false;
            }
            
            try {
                updateSyncStatus('syncing');
                const ref = await database.ref(path).push(data);
                // Store the Firebase key for future updates
                data.firebaseKey = ref.key;
                updateSyncStatus('synced');
                return ref.key;
            } catch (error) {
                console.warn("âš ï¸ Firebase save failed, falling back to local:", error.message);
                updateSyncStatus('error');
                return false;
            }
        }
        
        // Update existing data in Firebase
        async function updateInFirebase(path, firebaseKey, data) {
            if (!isFirebaseConfigured) {
                console.log("Firebase not configured, saving locally only");
                return false;
            }
            
            try {
                updateSyncStatus('syncing');
                if (firebaseKey) {
                    // Update existing record
                    await database.ref(`${path}/${firebaseKey}`).set(data);
                }
else {
  throw new Error("Cloud save failed");
}
updateSyncStatus('synced');
                return true;
            } catch (error) {
                console.warn("âš ï¸ Firebase update failed, falling back to local:", error.message);
                updateSyncStatus('error');
                return false;
            }
        }
        
        // Delete data from Firebase
        async function deleteFromFirebase(path, firebaseKey) {
            if (!isFirebaseConfigured || !firebaseKey) {
                console.log("Firebase not configured or no key provided");
                return false;
            }
            
            try {
                updateSyncStatus('syncing');
                await database.ref(`${path}/${firebaseKey}`).remove();
                updateSyncStatus('synced');
                return true;
            } catch (error) {
                console.warn("âš ï¸ Firebase delete failed:", error.message);
                updateSyncStatus('error');
                return false;
            }
        }

        // Demo users - keeping only admin user for fresh start
        const demoUsers = {
            'admin_user': {
                password: 'admin123',
                role: 'admin',
                name: 'Admin User',
                id: 'admin001'
            }
        };

        // Sales data - starting fresh with empty array
        let salesData = JSON.parse(localStorage.getItem('edenSalesData')) || [];
        let currentUser = null;
        
        // Products data - starting fresh with empty array
        let productsData = JSON.parse(localStorage.getItem('edenProductsData')) || [];
        
        // Store-specific pricing data - starting fresh with empty array
        let storePricingData = JSON.parse(localStorage.getItem('edenStorePricingData')) || [];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');
            setupDateConstraints();
            checkAuthState();
            updateDateTime();
            loadLastSyncTime();
            setInterval(updateDateTime, 1000); // Update every second
            
            // Auto-refresh data every 3 seconds if Firebase is configured
            setInterval(() => {
                if (isFirebaseConfigured && currentUser) {
                    console.log('ðŸ”„ Auto-refreshing data...');
                    refreshCurrentPageData();
                }
            }, 3000); // Auto-refresh every 3 seconds
            
            // Setup login form handler directly
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                console.log('Login form found, setting up handler...');
                loginForm.addEventListener('submit', handleLogin);
            } else {
                console.error('Login form not found!');
            }
            
            // Setup sales form handler
            const salesForm = document.getElementById('salesForm');
            if (salesForm) {
                salesForm.addEventListener('submit', handleSaleEntry, { once: true });
            }
            
            // Setup modal handlers
            setupModalHandlers();
        });

        function setupDateConstraints() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            const todayStr = today.toISOString().split('T')[0];
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            const dateInput = document.getElementById('saleDate');
            if (dateInput) {
                dateInput.min = yesterdayStr;
                dateInput.max = todayStr;
                dateInput.valueAsDate = today;
            }
        }

        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            const dateTimeStr = now.toLocaleDateString('en-US', options);
            
            // Update all date time displays
            const loginDateTime = document.getElementById('loginDateTime');
            const salesDateTime = document.getElementById('salesDateTime');
            const adminDateTime = document.getElementById('adminDateTime');
            const productsDateTime = document.getElementById('productsDateTime');
            const reportsDateTime = document.getElementById('reportsDateTime');
            
            if (loginDateTime) loginDateTime.textContent = dateTimeStr;
            if (salesDateTime) salesDateTime.textContent = dateTimeStr;
            if (adminDateTime) adminDateTime.textContent = dateTimeStr;
            if (productsDateTime) productsDateTime.textContent = dateTimeStr;
            if (reportsDateTime) reportsDateTime.textContent = dateTimeStr;
        }

        async function handleLogin(e) {
            console.log('ðŸ” Login attempt started');
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim().toLowerCase();
            const password = document.getElementById('password').value.trim();
            
            console.log('Login attempt:', username, password ? 'password provided' : 'no password');
            
            showLoading(true);
            hideMessages();
            
            try {
                // Check demo users first (for fresh database)
                const demoUser = demoUsers[username];
                if (!demoUser || demoUser.password !== password) {
                    throw new Error('Invalid username or password');
                }
                
                currentUser = {
                    ...demoUser,
                    username: username
                };
                console.log('âœ… Login successful for:', currentUser.name);
                
                // Store session immediately
                sessionStorage.setItem('edenUser', JSON.stringify(currentUser));
                
                showSuccess('Login successful!');
                
                // Show dashboard immediately, don't wait for Firebase
                setTimeout(() => {
                    showDashboard(currentUser.role);
                }, 500);
                
                // Handle Firebase migration in background (non-blocking)
                if (isFirebaseConfigured) {
                    console.log('ðŸ”¥ Firebase is configured, migrating user data in background...');
                    
                    // Don't await this - let it run in background
                    database.ref(`users/${username}`).set(demoUser).then(() => {
                        console.log('âœ… User migrated to Firebase successfully');
                        
                        // Also migrate to employees collection
                        const employeeData = {
                            id: demoUser.id,
                            username: username,
                            name: demoUser.name,
                            role: demoUser.role,
                            status: 'active',
                            lastActive: new Date().toISOString(),
                            createdAt: new Date().toISOString(),
                            password: demoUser.password
                        };
                        return (async function() {
  try {
    const snap = await database.ref('employees')
      .orderByChild('username').equalTo(username).once('value');
    if (!snap.exists()) {
      await database.ref('employees').child((employeeData.username || `emp_${Math.random().toString(36).slice(2,8)}`).replace(/[.#$\[\]]/g,'_')).set(employeeData);
    }
  } catch (e) {
    console.error('Employee write failed (dedup check):', e);
  }
})();
                    }).then(() => {
                        console.log('âœ… Employee data migrated to Firebase successfully');
                        updateSyncStatus('synced');
                    }).catch(migrationError => {
                        console.error('âŒ Firebase migration failed:', migrationError);
                        updateSyncStatus('error');
                    });
                } else {
                    throw new Error('Cloud not configured. Please set Firebase config.');
                }
                
            } catch (error) {
                console.error('âŒ Login error:', error.message);
                showLoading(false);
                showError(error.message);
                
                const glassElement = document.querySelector('.glass-morphism');
                if (glassElement) {
                    glassElement.classList.add('pulse-error');
                    setTimeout(() => {
                        glassElement.classList.remove('pulse-error');
                    }, 600);
                }
            }
        }
        
        // Initialize user data on first login
        async function initializeUserData() {
            if (!isFirebaseConfigured) return;
            
            try {
                console.log('ðŸ”„ Initializing user data...');
                
                // Check if initial data exists, if not, populate it
                const salesSnapshot = await database.ref('sales').once('value');
                if (!salesSnapshot.exists() && salesData.length > 0) {
                    console.log('ðŸ“Š Populating initial sales data...');
                    for (const sale of salesData) {
                        await database.ref('sales').child(`${sale.employeeId}_${sale.date}_${sale.product}_${Math.floor(Date.now()/5000)}`).set(sale);
                    }
                }
                
                const productsSnapshot = await database.ref('products').once('value');
                if (!productsSnapshot.exists() && productsData.length > 0) {
                    console.log('ðŸ“¦ Populating initial products data...');
                    for (const product of productsData) {
                        await database.ref('products').child((((product.name || product.productName) || `prod_${Math.random().toString(36).slice(2,8)}`).replace(/[.#$\[\]]/g,'_'))).set(product);
                    }
                }
                
                const storesSnapshot = await database.ref('stores').once('value');
                if (!storesSnapshot.exists() && storesData.length > 0) {
                    console.log('ðŸª Populating initial stores data...');
                    for (const store of storesData) {
                        await database.ref('stores').child((((store.name || store.storeName) || `store_${Math.random().toString(36).slice(2,8)}`).replace(/[.#$\[\]]/g,'_'))).set(store);
                    }
                }
                
                const pricingSnapshot = await database.ref('storePricing').once('value');
                if (!pricingSnapshot.exists() && storePricingData.length > 0) {
                    console.log('ðŸ’° Populating initial pricing data...');
                    for (const pricing of storePricingData) {
                        await database.ref('storePricing').child(`${(pricing.storeName||'store').replace(/[.#$\[\]]/g,'_')}__${(pricing.productName||'product').replace(/[.#$\[\]]/g,'_')}`).set(pricing);
                    }
                }
                
                console.log('âœ… User data initialization complete');
                
            } catch (error) {
                console.error('âŒ Error initializing user data:', error);
            }
        }

        async function handleSaleEntry(e) {
            e.preventDefault();
            
            const storeName = document.getElementById('storeName').value;
            const saleDate = document.getElementById('saleDate').value;
            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            
            // Show loading state
            submitButton.innerHTML = 'ðŸ’¾ Saving...';
            submitButton.disabled = true;
            
            try {
                // Store default values for future entries
                const userDefaults = JSON.parse(sessionStorage.getItem('edenUserDefaults')) || {};
                if (!userDefaults[currentUser.id]) {
                    userDefaults[currentUser.id] = {
                        storeName: storeName,
                        date: saleDate
                    };
                    sessionStorage.setItem('edenUserDefaults', JSON.stringify(userDefaults));
                }
                
                const sale = {
                    id: Date.now(),
                    employeeId: currentUser.id,
                    employeeName: currentUser.name,
                    storeName: storeName,
                    product: document.getElementById('product').value,
                    quantity: parseInt(document.getElementById('quantity').value),
                    amount: parseFloat(document.getElementById('amount').value),
                    unitPrice: parseFloat(document.getElementById('unitPrice').value),
                    date: saleDate,
                    timestamp: new Date().toISOString(),
                    syncStatus: 'pending'
                };

                console.log('ðŸ’¾ Saving sale entry:', sale);

                // Save to Firebase first, then update local data
                const firebaseKey = await saveToFirebase('sales', sale);
                
                if (firebaseKey) {
                    // Firebase will trigger the real-time listener to update salesData
                    console.log('âœ… Sale saved to Firebase successfully with key:', firebaseKey);
                    
                    // Show success feedback
                    submitButton.innerHTML = 'âœ… Saved to Cloud!';
                    submitButton.style.background = 'linear-gradient(135deg, #10B981 0%, #059669 100%)';
                    
                } else {
                    // Fallback to local storage
                    sale.syncStatus = 'local';
                    salesData.push(sale);
                    localStorage.setItem('edenSalesData', JSON.stringify(salesData));
                    updateSyncStatus('error');
                    
                    console.log('âš ï¸ Sale saved locally (Firebase unavailable)');
                    
                    // Show local save feedback
                    submitButton.innerHTML = 'ðŸ’¾ Saved Locally';
                    submitButton.style.background = 'linear-gradient(135deg, #F59E0B 0%, #D97706 100%)';
                    
                    // Update displays immediately for local saves
                    updateSalesStats();
                    updateRecentSales();
                }
                
                // Reset form but keep defaults
                document.getElementById('product').value = '';
                document.getElementById('quantity').value = '1';
                document.getElementById('unitPrice').value = '';
                document.getElementById('amount').value = '';
                
                // Reset button after delay
                setTimeout(() => {
                    submitButton.innerHTML = originalText;
                    submitButton.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    submitButton.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('âŒ Error saving sale:', error);
                
                // Show error feedback
                submitButton.innerHTML = 'âŒ Error - Try Again';
                submitButton.style.background = 'linear-gradient(135deg, #EF4444 0%, #DC2626 100%)';
                
                setTimeout(() => {
                    submitButton.innerHTML = originalText;
                    submitButton.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    submitButton.disabled = false;
                }, 3000);
                
                updateSyncStatus('error');
            }
        }

        function showDashboard(role) {
            showLoading(false);
            document.getElementById('loginPage').classList.add('hidden');
            
            if (role === 'admin') {
                document.getElementById('adminPage').classList.remove('hidden');
                document.getElementById('adminName').textContent = `Welcome, ${currentUser.name}`;
                updateAdminStats();
            } else {
                document.getElementById('salesPage').classList.remove('hidden');
                document.getElementById('employeeName').textContent = `Welcome, ${currentUser.name}`;
                
                // Load user defaults
                const userDefaults = JSON.parse(sessionStorage.getItem('edenUserDefaults')) || {};
                const defaults = userDefaults[currentUser.id];
                
                if (defaults) {
                    document.getElementById('storeName').value = defaults.storeName;
                    document.getElementById('saleDate').value = defaults.date;
                } else {
                    setupDateConstraints(); // Set default date if no defaults exist
                }
                
                updateSalesStats();
                updateRecentSales();
            }
        }

        function updateSalesStats() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            const todaySales = salesData.filter(sale => 
                sale.date === todayStr && sale.employeeId === currentUser.id
            );
            
            const todayAmount = todaySales.reduce((sum, sale) => sum + (sale.amount || 0), 0);
            const todayQty = todaySales.reduce((sum, sale) => sum + (sale.quantity || 1), 0);
            
            document.getElementById('todaySalesAmount').textContent = `${todayAmount.toFixed(2)} DHS`;
            document.getElementById('todayQtyCount').textContent = todayQty;
        }

        function updateRecentSales() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            const todaySales = salesData
                .filter(sale => sale.date === todayStr && sale.employeeId === currentUser.id)
                .slice(-5)
                .reverse();
            
            const listDiv = document.getElementById('recentSalesList');
            
            if (todaySales.length === 0) {
                listDiv.innerHTML = '<div class="text-white/50 text-center py-8 font-medium">No sales yet today</div>';
                return;
            }

            listDiv.innerHTML = todaySales.map(sale => `
                <div class="flex justify-between items-center p-4 bg-white/5 rounded-2xl border border-white/10 hover:bg-white/10 transition-all">
                    <div class="flex-1">
                        <div class="font-bold text-white">${sale.storeName}</div>
                        <div class="text-sm text-white/60">${sale.product} â€¢ Qty: ${sale.quantity}</div>
                    </div>
                    <div class="text-sm font-bold text-premium bg-white/5 px-3 py-1 rounded-lg">${sale.amount.toFixed(2)} DHS</div>
                </div>
            `).join('');
        }

        function updateAdminStats() {
            const totalSales = salesData.length;
            const totalRevenue = salesData.reduce((sum, sale) => sum + sale.amount, 0);
            const avgSale = totalSales > 0 ? totalRevenue / totalSales : 0;
            
            document.getElementById('totalSalesCount').textContent = totalSales;
            document.getElementById('totalRevenue').textContent = `${totalRevenue.toFixed(2)} DHS`;
            document.getElementById('activeUsers').textContent = Object.keys(demoUsers).length;
            document.getElementById('avgSaleAmount').textContent = `${avgSale.toFixed(2)} DHS`;
            
            // Initialize management lists
            updateEmployeesList();
            updateStoresList();
            updatePricingList();
        }

        function checkAuthState() {
            const storedUser = sessionStorage.getItem('edenUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                showDashboard(currentUser.role);
            }
        }

        function logout() {
            sessionStorage.removeItem('edenUser');
            sessionStorage.removeItem('edenUserDefaults');
            currentUser = null;
            
            // Hide all pages
            document.getElementById('salesPage').classList.add('hidden');
            document.getElementById('adminPage').classList.add('hidden');
            document.getElementById('salesReportPage').classList.add('hidden');
            document.getElementById('productsPage').classList.add('hidden');
            
            // Show login page
            document.getElementById('loginPage').classList.remove('hidden');
            
            // Reset form
            document.getElementById('loginForm').reset();
            hideMessages();
        }

        // UI Helper Functions
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const eyeIcon = document.getElementById('eyeIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
                `;
            } else {
                passwordInput.type = 'password';
                eyeIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                `;
            }
        }

        function showLoading(show) {
            const loginBtn = document.getElementById('loginBtn');
            const loginBtnText = document.getElementById('loginBtnText');
            const loginSpinner = document.getElementById('loginSpinner');
            
            if (show) {
                loginBtn.disabled = true;
                loginBtnText.classList.add('hidden');
                loginSpinner.classList.remove('hidden');
            } else {
                loginBtn.disabled = false;
                loginBtnText.classList.remove('hidden');
                loginSpinner.classList.add('hidden');
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
            
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            const successText = document.getElementById('successText');
            
            successText.textContent = message;
            successDiv.classList.remove('hidden');
            
            setTimeout(() => {
                successDiv.classList.add('hidden');
            }, 3000);
        }

        function hideMessages() {
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('successMessage').classList.add('hidden');
        }

        function simulateNetworkDelay() {
            return new Promise(resolve => setTimeout(resolve, 800));
        }

        function updateSyncStatus(status) {
            let statusHTML = '';
            switch(status) {
                case 'synced':
                    statusHTML = `
                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                        <span class="text-xs text-green-400 font-medium">SYNCED</span>
                    `;
                    updateLastSyncTime();
                    break;
                case 'syncing':
                    statusHTML = `
                        <div class="w-2 h-2 bg-yellow-400 rounded-full animate-spin"></div>
                        <span class="text-xs text-yellow-400 font-medium">SYNCING</span>
                    `;
                    break;
                case 'error':
                    statusHTML = `
                        <div class="w-2 h-2 bg-red-400 rounded-full"></div>
                        <span class="text-xs text-red-400 font-medium">ERROR</span>
                    `;
                    break;
                case 'local':
                    statusHTML = `
                        <div class="w-2 h-2 bg-red-400 rounded-full"></div>
                        <span class="text-xs text-red-400 font-medium">ERROR</span>
                    `;
                    break;
            }
            
            // Update all sync status indicators
            const syncStatusDivs = ['syncStatus', 'loginSyncStatus', 'adminSyncStatus', 'productsSyncStatus', 'reportsSyncStatus'];
            syncStatusDivs.forEach(id => {
                const div = document.getElementById(id);
                if (div) div.innerHTML = statusHTML;
            });
        }

        function updateLastSyncTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            const syncText = `Last sync: ${timeString}`;
            
            // Store the last sync time
            localStorage.setItem('edenLastSync', now.toISOString());
            
            // Update all last sync time displays
            const syncTimeDivs = ['lastSyncTime', 'adminLastSync', 'reportsLastSync', 'productsLastSync'];
            syncTimeDivs.forEach(id => {
                const div = document.getElementById(id);
                if (div) div.textContent = syncText;
            });
        }

        function loadLastSyncTime() {
            const lastSync = localStorage.getItem('edenLastSync');
            if (lastSync) {
                const syncDate = new Date(lastSync);
                const timeString = syncDate.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                const syncText = `Last sync: ${timeString}`;
                
                // Update all last sync time displays
                const syncTimeDivs = ['lastSyncTime', 'adminLastSync', 'reportsLastSync', 'productsLastSync'];
                syncTimeDivs.forEach(id => {
                    const div = document.getElementById(id);
                    if (div) div.textContent = syncText;
                });
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        // Data storage for management - keeping only admin user
        let employeesData = JSON.parse(localStorage.getItem('edenEmployeesData')) || [
            { id: 'admin001', username: 'admin_user', name: 'Admin User', role: 'admin', status: 'online', lastActive: 'Now' }
        ];
        
        let storesData = JSON.parse(localStorage.getItem('edenStoresData')) || [];

        // Management Functions
        function showManagementTab(tab) {
            // Hide all sections
            document.querySelectorAll('.management-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Remove active state from all tabs
            document.querySelectorAll('[id$="Tab"]').forEach(tabBtn => {
                tabBtn.classList.remove('bg-white/10', 'text-white');
                tabBtn.classList.add('text-white/60');
            });
            
            // Show selected section
            document.getElementById(tab + 'Management').classList.remove('hidden');
            
            // Activate selected tab
            const activeTab = document.getElementById(tab + 'Tab');
            activeTab.classList.add('bg-white/10', 'text-white');
            activeTab.classList.remove('text-white/60');
            
            // Update the respective list
            if (tab === 'employees') updateEmployeesList();
            if (tab === 'stores') updateStoresList();
            if (tab === 'pricing') updatePricingList();
        }

        // Employee Management
        function showAddEmployeeModal() {
            currentEditItem = null;
            document.getElementById('modalTitle').textContent = 'Add Employee';
            document.getElementById('modalFields').innerHTML = `
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-3">Username</label>
                    <input type="text" name="username" required class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium" placeholder="Enter username">
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-3">Full Name</label>
                    <input type="text" name="fullName" required class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium" placeholder="Enter full name">
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-3">Password</label>
                    <input type="password" name="password" required class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium" placeholder="Enter password">
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-3">Role</label>
                    <select name="role" required class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium">
                        <option value="">Select role</option>
                        <option value="employee">Employee</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
            `;
            document.getElementById('modalOverlay').classList.remove('hidden');
        }

        function editEmployee(employeeId) {
            const employee = employeesData.find(emp => emp.id === employeeId);
            if (!employee) return;
            
            currentEditItem = employee;
            document.getElementById('modalTitle').textContent = 'Edit Employee';
            document.getElementById('modalFields').innerHTML = `
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-3">Username</label>
                    <input type="text" name="username" required class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium" value="${employee.username}">
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-3">Full Name</label>
                    <input type="text" name="fullName" required class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium" value="${employee.name}">
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-3">New Password (leave blank to keep current)</label>
                    <input type="password" name="password" class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium" placeholder="Enter new password">
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-3">Role</label>
                    <select name="role" required class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium">
                        <option value="employee" ${employee.role === 'employee' ? 'selected' : ''}>Employee</option>
                        <option value="admin" ${employee.role === 'admin' ? 'selected' : ''}>Admin</option>
                    </select>
                </div>
            `;
            document.getElementById('modalOverlay').classList.remove('hidden');
        }

        function deleteEmployee(employeeId) {
            if (employeeId === 'admin001') {
                showCustomAlert('Cannot delete the main admin account!');
                return;
            }
            
            const employee = employeesData.find(emp => emp.id === employeeId);
            if (!employee) return;
            
            showCustomConfirm(`Are you sure you want to delete employee: ${employee.name}?`, () => {
                // Delete from Firebase first
                if (employee.firebaseKey) {
                    deleteFromFirebase('employees', employee.firebaseKey);
                }
                
                // Delete user from Firebase
                if (demoUsers[employee.username] && demoUsers[employee.username].firebaseKey) {
                    deleteFromFirebase('users', demoUsers[employee.username].firebaseKey);
                }
                
                employeesData = employeesData.filter(emp => emp.id !== employeeId);
                // Also remove from demo users
                delete demoUsers[employee.username];
                localStorage.setItem('edenEmployeesData', JSON.stringify(employeesData));
                updateEmployeesList();
                showSuccessMessage('Employee deleted successfully!');
            });
        }

        function updateEmployeesList() {
            const listDiv = document.getElementById('employeesList');
            
            if (employeesData.length === 0) {
                listDiv.innerHTML = '<div class="text-white/50 text-center py-8 font-medium">No employees found</div>';
                return;
            }

            listDiv.innerHTML = employeesData.map(employee => `
                <div class="flex items-center justify-between p-6 bg-white/5 rounded-2xl border border-white/10 hover:bg-white/10 transition-all">
                    <div>
                        <div class="font-bold text-white text-lg">${employee.username}</div>
                        <div class="text-sm text-white/60">${employee.name} â€¢ ${employee.role} â€¢ Last active: ${employee.lastActive}</div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="px-4 py-2 ${employee.status === 'online' ? 'bg-blue-500/20 text-blue-300 border-blue-500/30' : 'bg-green-500/20 text-green-300 border-green-500/30'} rounded-full text-sm font-bold border">${employee.status.toUpperCase()}</span>
                        <button onclick="editEmployee('${employee.id}')" class="text-blue-400 hover:text-blue-300 font-medium">Edit</button>
                        <button onclick="deleteEmployee('${employee.id}')" class="text-red-400 hover:text-red-300 font-medium">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Store Management
        function showAddStoreModal() {
            currentEditItem = null;
            document.getElementById('modalTitle').textContent = 'Add Store';
            document.getElementById('modalFields').innerHTML = `
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-3">Store Name</label>
                    <input type="text" name="storeName" required class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium" placeholder="Enter store name">
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-3">Location</label>
                    <input type="text" name="location" required class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium" placeholder="Enter location">
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-3">Description</label>
                    <input type="text" name="description" class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium" placeholder="Enter description">
                </div>
            `;
            document.getElementById('modalOverlay').classList.remove('hidden');
        }

        function editStore(storeName) {
            const store = storesData.find(s => s.name === storeName);
            if (!store) return;
            
            currentEditItem = store;
            document.getElementById('modalTitle').textContent = 'Edit Store';
            document.getElementById('modalFields').innerHTML = `
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-3">Store Name</label>
                    <input type="text" name="storeName" required class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium" value="${store.name}">
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-3">Location</label>
                    <input type="text" name="location" required class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium" value="${store.location}">
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-3">Description</label>
                    <input type="text" name="description" class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium" value="${store.description || ''}">
                </div>
            `;
            document.getElementById('modalOverlay').classList.remove('hidden');
        }

        function deleteStore(storeName) {
            const store = storesData.find(s => s.name === storeName);
            if (!store) return;
            
            showCustomConfirm(`Are you sure you want to delete store: ${store.name}?`, () => {
                // Delete from Firebase first
                if (store.firebaseKey) {
                    deleteFromFirebase('stores', store.firebaseKey);
                }
                
                storesData = storesData.filter(s => s.name !== storeName);
                localStorage.setItem('edenStoresData', JSON.stringify(storesData));
                updateStoresList();
                showSuccessMessage('Store deleted successfully!');
            });
        }

        function updateStoresList() {
            const listDiv = document.getElementById('storesList');
            
            if (storesData.length === 0) {
                listDiv.innerHTML = '<div class="text-white/50 text-center py-8 font-medium">No stores found</div>';
                return;
            }

            listDiv.innerHTML = storesData.map(store => `
                <div class="flex items-center justify-between p-6 bg-white/5 rounded-2xl border border-white/10 hover:bg-white/10 transition-all">
                    <div>
                        <div class="font-bold text-white text-lg">${store.name}</div>
                        <div class="text-sm text-white/60">${store.location} â€¢ ${store.description || 'No description'}</div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="px-4 py-2 bg-green-500/20 text-green-300 rounded-full text-sm font-bold border border-green-500/30">${store.status.toUpperCase()}</span>
                        <button onclick="editStore('${store.name}')" class="text-blue-400 hover:text-blue-300 font-medium">Edit</button>
                        <button onclick="deleteStore('${store.name}')" class="text-red-400 hover:text-red-300 font-medium">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Product Management (Admin Page)
        function showAddProductModal() {
            // Check if we're on the products page or admin page
            const isProductsPage = !document.getElementById('productsPage').classList.contains('hidden');
            
            if (isProductsPage) {
                currentEditProductItem = null;
                document.getElementById('productModalTitle').textContent = 'Add Product';
                document.querySelector('#productModalForm input[name="productName"]').value = '';
                document.querySelector('#productModalForm input[name="price"]').value = '';
                document.getElementById('productModalOverlay').classList.remove('hidden');
            } else {
                currentEditItem = null;
                document.getElementById('modalTitle').textContent = 'Add Product';
                document.getElementById('modalFields').innerHTML = `
                    <div>
                        <label class="block text-sm font-medium text-white/90 mb-3">Product Name</label>
                        <input type="text" name="productName" required class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium" placeholder="Enter product name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-white/90 mb-3">Price (DHS)</label>
                        <input type="number" name="price" required step="0.01" min="0" class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium" placeholder="0.00">
                    </div>
                `;
                document.getElementById('modalOverlay').classList.remove('hidden');
            }
        }

        function editProduct(productName) {
            const product = productsData.find(p => p.name === productName);
            if (!product) return;
            
            currentEditItem = product;
            document.getElementById('modalTitle').textContent = 'Edit Product';
            document.getElementById('modalFields').innerHTML = `
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-3">Product Name</label>
                    <input type="text" name="productName" required class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium" value="${product.name}">
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-3">Price (DHS)</label>
                    <input type="number" name="price" required step="0.01" min="0" class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium" value="${product.price}">
                </div>
            `;
            document.getElementById('modalOverlay').classList.remove('hidden');
        }

        function deleteProduct(productName) {
            const product = productsData.find(p => p.name === productName);
            if (!product) return;
            
            showCustomConfirm(`Are you sure you want to delete product: ${product.name}?`, () => {
                // Delete from Firebase first
                if (product.firebaseKey) {
                    deleteFromFirebase('products', product.firebaseKey);
                }
                
                productsData = productsData.filter(p => p.name !== productName);
                localStorage.setItem('edenProductsData', JSON.stringify(productsData));
                updateProductsManagementList();
                showSuccessMessage('Product deleted successfully!');
            });
        }

        function updateProductsManagementList() {
            const listDiv = document.getElementById('productsList');
            
            if (productsData.length === 0) {
                listDiv.innerHTML = '<div class="text-white/50 text-center py-8 font-medium">No products found</div>';
                return;
            }

            listDiv.innerHTML = productsData.map(product => `
                <div class="flex items-center justify-between p-6 bg-white/5 rounded-2xl border border-white/10 hover:bg-white/10 transition-all">
                    <div>
                        <div class="font-bold text-white text-lg">${product.name}</div>
                        <div class="text-sm text-white/60">Price: ${product.price.toFixed(2)} DHS</div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="px-4 py-2 bg-green-500/20 text-green-300 rounded-full text-sm font-bold border border-green-500/30">ACTIVE</span>
                        <button onclick="editProduct('${product.name}')" class="text-blue-400 hover:text-blue-300 font-medium">Edit</button>
                        <button onclick="deleteProduct('${product.name}')" class="text-red-400 hover:text-red-300 font-medium">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.add('hidden');
            currentEditItem = null;
        }

        // Global variables for tracking edits
        let currentEditItem = null;
        let currentEditProductItem = null;

        // Setup modal form handlers
        function setupModalHandlers() {
            const modalForm = document.getElementById('modalForm');
            if (modalForm) {
                modalForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const data = Object.fromEntries(formData);
                    
                    if (currentEditItem) {
                        // Edit existing item
                        if (data.username !== undefined) {
                            // Employee edit
                            const oldUsername = currentEditItem.username;
                            currentEditItem.username = data.username;
                            currentEditItem.name = data.fullName;
                            currentEditItem.role = data.role;
                            currentEditItem.lastUpdated = new Date().toISOString();
                            
                            if (data.password && data.password.trim()) {
                                // Update password in both employee record and demo users
                                currentEditItem.password = data.password;
                                
                                if (demoUsers[oldUsername]) {
                                    // If username changed, move the user record
                                    if (oldUsername !== data.username) {
                                        demoUsers[data.username] = {
                                            ...demoUsers[oldUsername],
                                            password: data.password
                                        };
                                        delete demoUsers[oldUsername];
                                        
                                        // Remove old user from Firebase and add new one
                                        database.ref(`users/${oldUsername}`).remove();
                                        database.ref(`users/${data.username}`).set(demoUsers[data.username]);
                                    } else {
                                        demoUsers[data.username].password = data.password;
                                        // Update user in Firebase
                                        database.ref(`users/${data.username}`).update({ password: data.password });
                                    }
                                }
                            } else if (oldUsername !== data.username) {
                                // Username changed but no new password - move user record
                                if (demoUsers[oldUsername]) {
                                    demoUsers[data.username] = demoUsers[oldUsername];
                                    delete demoUsers[oldUsername];
                                    
                                    // Move user in Firebase
                                    database.ref(`users/${oldUsername}`).remove();
                                    database.ref(`users/${data.username}`).set(demoUsers[data.username]);
                                }
                            }
                            
                            // Update employee in Firebase
                            updateInFirebase('employees', currentEditItem.firebaseKey, currentEditItem);
                            
                            localStorage.setItem('edenEmployeesData', JSON.stringify(employeesData));
                            updateEmployeesList();
                            showSuccessMessage('Employee updated successfully!');
                        } else if (data.storeName !== undefined) {
                            // Store edit
                            currentEditItem.name = data.storeName;
                            currentEditItem.location = data.location;
                            currentEditItem.description = data.description || '';
                            
                            // Update in Firebase
                            updateInFirebase('stores', currentEditItem.firebaseKey, currentEditItem);
                            
                            localStorage.setItem('edenStoresData', JSON.stringify(storesData));
                            updateStoresList();
                            showSuccessMessage('Store updated successfully!');
                        } else if (data.productName !== undefined && data.customPrice !== undefined) {
                            // Pricing edit
                            currentEditItem.productName = data.productName;
                            currentEditItem.storeName = data.storeName;
                            currentEditItem.customPrice = parseFloat(data.customPrice);
                            
                            // Update in Firebase
                            updateInFirebase('storePricing', currentEditItem.firebaseKey, currentEditItem);
                            
                            localStorage.setItem('edenStorePricingData', JSON.stringify(storePricingData));
                            updatePricingList();
                            // Refresh unit price if currently viewing sales form with same product/store
                            setTimeout(() => {
                                refreshCurrentSalesFormPrice();
                            }, 100);
                            showSuccessMessage('Custom pricing updated successfully!');
                        } else if (data.productName !== undefined) {
                            // Product edit
                            currentEditItem.name = data.productName;
                            currentEditItem.price = parseFloat(data.price);
                            
                            // Update in Firebase
                            updateInFirebase('products', currentEditItem.firebaseKey, currentEditItem);
                            
                            localStorage.setItem('edenProductsData', JSON.stringify(productsData));
                            updateProductsManagementList();
                            // Refresh unit price if currently viewing sales form with same product
                            setTimeout(() => {
                                refreshCurrentSalesFormPrice();
                            }, 100);
                            showSuccessMessage('Product updated successfully!');
                        }
                    } else {
                        // Add new item
                        if (data.username !== undefined) {
                            // Add employee
                            const newEmployee = {
                                id: 'emp' + Date.now(),
                                username: data.username,
                                name: data.fullName,
                                role: data.role,
                                status: 'active',
                                lastActive: 'Never',
                                password: data.password, // Store password in employee record too
                                createdAt: new Date().toISOString()
                            };
                            
                            // Add to demo users for login first
                            const newUser = {
                                password: data.password,
                                role: data.role,
                                name: data.fullName,
                                id: newEmployee.id,
                                createdAt: new Date().toISOString()
                            };
                            demoUsers[data.username] = newUser;
                            
                            // Save to Firebase - both collections
                            Promise.all([
                                saveToFirebase('employees', newEmployee),
                                database.ref(`users/${data.username}`).set(newUser)
                            ]).then(([employeeKey, userResult]) => {
                                if (employeeKey) {
                                    newEmployee.firebaseKey = employeeKey;
                                }
                                console.log('âœ… Employee and user saved to Firebase:', data.username);
                            }).catch(error => {
                                console.error('âŒ Error saving employee to Firebase:', error);
                            });
                            
                            employeesData.push(newEmployee);
                            localStorage.setItem('edenEmployeesData', JSON.stringify(employeesData));
                            updateEmployeesList();
                            showSuccessMessage('Employee added successfully!');
                        } else if (data.storeName !== undefined) {
                            // Add store
                            const newStore = {
                                id: Date.now(),
                                name: data.storeName,
                                location: data.location,
                                description: data.description || '',
                                status: 'active'
                            };
                            
                            // Save to Firebase first
                            saveToFirebase('stores', newStore).then(firebaseKey => {
                                if (firebaseKey) {
                                    newStore.firebaseKey = firebaseKey;
                                }
                            });
                            
                            storesData.push(newStore);
                            localStorage.setItem('edenStoresData', JSON.stringify(storesData));
                            updateStoresList();
                            showSuccessMessage('Store added successfully!');
                        } else if (data.productName !== undefined && data.customPrice !== undefined) {
                            // Add pricing
                            const newPricing = {
                                id: Date.now(),
                                productName: data.productName,
                                storeName: data.storeName,
                                customPrice: parseFloat(data.customPrice)
                            };
                            
                            // Save to Firebase first
                            saveToFirebase('storePricing', newPricing).then(firebaseKey => {
                                if (firebaseKey) {
                                    newPricing.firebaseKey = firebaseKey;
                                }
                            });
                            
                            storePricingData.push(newPricing);
                            localStorage.setItem('edenStorePricingData', JSON.stringify(storePricingData));
                            updatePricingList();
                            // Refresh unit price if currently viewing sales form with same product/store
                            setTimeout(() => {
                                refreshCurrentSalesFormPrice();
                            }, 100);
                            showSuccessMessage('Custom pricing added successfully!');
                        } else if (data.productName !== undefined) {
                            // Add product
                            const newProduct = {
                                id: Date.now(),
                                name: data.productName,
                                price: parseFloat(data.price)
                            };
                            
                            // Save to Firebase first
                            saveToFirebase('products', newProduct).then(firebaseKey => {
                                if (firebaseKey) {
                                    newProduct.firebaseKey = firebaseKey;
                                }
                            });
                            
                            productsData.push(newProduct);
                            localStorage.setItem('edenProductsData', JSON.stringify(productsData));
                            updateProductsManagementList();
                            // Refresh unit price if currently viewing sales form
                            setTimeout(() => {
                                refreshCurrentSalesFormPrice();
                            }, 100);
                            showSuccessMessage('Product added successfully!');
                        }
                    }
                    
                    closeModal();
                });
            }
            
            const productModalForm = document.getElementById('productModalForm');
            if (productModalForm) {
                productModalForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const data = Object.fromEntries(formData);
                    
                    if (currentEditProductItem) {
                        // Edit existing product
                        currentEditProductItem.name = data.productName;
                        currentEditProductItem.price = parseFloat(data.price);
                        
                        // Update in Firebase
                        updateInFirebase('products', currentEditProductItem.firebaseKey, currentEditProductItem);
                        
                        localStorage.setItem('edenProductsData', JSON.stringify(productsData));
                        updateProductsList();
                        showSuccessMessage('Product updated successfully!');
                    } else {
                        // Add new product
                        const newProduct = {
                            id: Date.now(),
                            name: data.productName,
                            price: parseFloat(data.price)
                        };
                        
                        // Save to Firebase first
                        saveToFirebase('products', newProduct).then(firebaseKey => {
                            if (firebaseKey) {
                                newProduct.firebaseKey = firebaseKey;
                            }
                        });
                        
                        productsData.push(newProduct);
                        localStorage.setItem('edenProductsData', JSON.stringify(productsData));
                        updateProductsList();
                        showSuccessMessage('Product added successfully!');
                    }
                    
                    closeProductModal();
                });
            }
        }
        
        function showSuccessMessage(message) {
            // Create a temporary success notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-6 right-6 bg-green-500/20 border border-green-500/30 text-green-300 px-6 py-4 rounded-2xl text-sm backdrop-blur-sm z-50 fade-in';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        function showCustomAlert(message) {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-6';
            overlay.innerHTML = `
                <div class="premium-card rounded-3xl p-8 max-w-md w-full">
                    <h3 class="text-xl font-bold text-white mb-4">Alert</h3>
                    <p class="text-white/80 mb-6">${message}</p>
                    <button onclick="this.closest('.fixed').remove()" class="premium-button w-full py-3 text-white font-bold rounded-xl">OK</button>
                </div>
            `;
            document.body.appendChild(overlay);
        }
        
        function showCustomConfirm(message, onConfirm) {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-6';
            overlay.innerHTML = `
                <div class="premium-card rounded-3xl p-8 max-w-md w-full">
                    <h3 class="text-xl font-bold text-white mb-4">Confirm</h3>
                    <p class="text-white/80 mb-6">${message}</p>
                    <div class="flex space-x-4">
                        <button onclick="confirmAction()" class="premium-button flex-1 py-3 text-white font-bold rounded-xl">Yes</button>
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 py-3 bg-white/10 text-white font-bold rounded-xl hover:bg-white/20 transition-all">Cancel</button>
                    </div>
                </div>
            `;
            
            // Add confirm action function to the overlay
            overlay.querySelector('button[onclick="confirmAction()"]').onclick = () => {
                onConfirm();
                overlay.remove();
            };
            
            document.body.appendChild(overlay);
        }
        
        function showProductsPage() {
            document.getElementById('salesPage').classList.add('hidden');
            document.getElementById('adminPage').classList.add('hidden');
            document.getElementById('productsPage').classList.remove('hidden');
            updateProductsList();
        }
        
        function goBackToDashboard() {
            // Hide all secondary pages
            document.getElementById('productsPage').classList.add('hidden');
            document.getElementById('salesReportPage').classList.add('hidden');
            
            // Show appropriate dashboard
            if (currentUser.role === 'admin') {
                document.getElementById('adminPage').classList.remove('hidden');
            } else {
                document.getElementById('salesPage').classList.remove('hidden');
            }
        }
        
        function updateProductsList() {
            const listDiv = document.getElementById('productsPageList');
            
            if (productsData.length === 0) {
                listDiv.innerHTML = '<div class="text-white/50 text-center py-8 font-medium">No products available</div>';
                return;
            }

            listDiv.innerHTML = productsData.map(product => `
                <div class="flex items-center justify-between p-6 bg-white/5 rounded-2xl border border-white/10 hover:bg-white/10 transition-all">
                    <div>
                        <div class="font-bold text-white text-lg">${product.name}</div>
                        <div class="text-sm text-white/60">Price: ${product.price.toFixed(2)} DHS</div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="px-4 py-2 bg-green-500/20 text-green-300 rounded-full text-sm font-bold border border-green-500/30">ACTIVE</span>
                        <button onclick="editProductItem(${product.id})" class="text-blue-400 hover:text-blue-300 font-medium">Edit</button>
                        <button onclick="deleteProductItem(${product.id})" class="text-red-400 hover:text-red-300 font-medium">Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        function editProductItem(productId) {
            const product = productsData.find(p => p.id === productId);
            if (!product) return;
            
            currentEditProductItem = product;
            document.getElementById('productModalTitle').textContent = 'Edit Product';
            document.querySelector('#productModalForm input[name="productName"]').value = product.name;
            document.querySelector('#productModalForm input[name="price"]').value = product.price;
            document.getElementById('productModalOverlay').classList.remove('hidden');
        }
        
        function deleteProductItem(productId) {
            const product = productsData.find(p => p.id === productId);
            if (!product) return;
            
            showCustomConfirm(`Are you sure you want to delete "${product.name}"?`, () => {
                // Delete from Firebase first
                if (product.firebaseKey) {
                    deleteFromFirebase('products', product.firebaseKey);
                }
                
                productsData = productsData.filter(p => p.id !== productId);
                localStorage.setItem('edenProductsData', JSON.stringify(productsData));
                updateProductsList();
                showSuccessMessage('Product deleted successfully!');
            });
        }
        
        function closeProductModal() {
            document.getElementById('productModalOverlay').classList.add('hidden');
            currentEditProductItem = null;
        }
        
        // Pricing Management Functions
        function showAddPricingModal() {
            currentEditItem = null;
            document.getElementById('modalTitle').textContent = 'Set Store Price';
            document.getElementById('modalFields').innerHTML = `
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-3">Product</label>
                    <select name="productName" required class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium">
                        <option value="">Select product</option>
                        ${productsData.map(product => `<option value="${product.name}">${product.name} (Default: ${product.price.toFixed(2)} DHS)</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-3">Store</label>
                    <select name="storeName" required class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium">
                        <option value="">Select store</option>
                        ${storesData.map(store => `<option value="${store.name}">${store.name}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-3">Custom Price (DHS)</label>
                    <input type="number" name="customPrice" required step="0.01" min="0" class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium" placeholder="0.00">
                </div>
            `;
            document.getElementById('modalOverlay').classList.remove('hidden');
        }
        
        function editPricing(pricingId) {
            const pricing = storePricingData.find(p => p.id === pricingId);
            if (!pricing) return;
            
            currentEditItem = pricing;
            document.getElementById('modalTitle').textContent = 'Edit Store Price';
            document.getElementById('modalFields').innerHTML = `
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-3">Product</label>
                    <select name="productName" required class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium">
                        ${productsData.map(product => `<option value="${product.name}" ${product.name === pricing.productName ? 'selected' : ''}>${product.name} (Default: ${product.price.toFixed(2)} DHS)</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-3">Store</label>
                    <select name="storeName" required class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium">
                        ${storesData.map(store => `<option value="${store.name}" ${store.name === pricing.storeName ? 'selected' : ''}>${store.name}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/90 mb-3">Custom Price (DHS)</label>
                    <input type="number" name="customPrice" required step="0.01" min="0" class="premium-input w-full px-5 py-4 rounded-xl focus:outline-none font-medium" value="${pricing.customPrice}">
                </div>
            `;
            document.getElementById('modalOverlay').classList.remove('hidden');
        }
        
        function deletePricing(pricingId) {
            const pricing = storePricingData.find(p => p.id === pricingId);
            if (!pricing) return;
            
            showCustomConfirm(`Remove custom pricing for ${pricing.productName} at ${pricing.storeName}?`, () => {
                // Delete from Firebase first
                if (pricing.firebaseKey) {
                    deleteFromFirebase('storePricing', pricing.firebaseKey);
                }
                
                storePricingData = storePricingData.filter(p => p.id !== pricingId);
                localStorage.setItem('edenStorePricingData', JSON.stringify(storePricingData));
                updatePricingList();
                // Refresh unit price if currently viewing sales form with same product/store
                setTimeout(() => {
                    refreshCurrentSalesFormPrice();
                }, 100);
                showSuccessMessage('Custom pricing removed successfully!');
            });
        }
        
        function updatePricingList() {
            const listDiv = document.getElementById('pricingList');
            
            if (storePricingData.length === 0) {
                listDiv.innerHTML = '<div class="text-white/50 text-center py-8 font-medium">No custom pricing set. All products use default prices.</div>';
                return;
            }

            listDiv.innerHTML = storePricingData.map(pricing => {
                const defaultProduct = productsData.find(p => p.name === pricing.productName);
                const defaultPrice = defaultProduct ? defaultProduct.price : 0;
                const priceDiff = pricing.customPrice - defaultPrice;
                const diffColor = priceDiff > 0 ? 'text-red-400' : priceDiff < 0 ? 'text-green-400' : 'text-white/60';
                const diffText = priceDiff > 0 ? `+${priceDiff.toFixed(2)}` : priceDiff < 0 ? `${priceDiff.toFixed(2)}` : 'Same';
                
                return `
                    <div class="flex items-center justify-between p-6 bg-white/5 rounded-2xl border border-white/10 hover:bg-white/10 transition-all">
                        <div class="flex-1">
                            <div class="font-bold text-white text-lg">${pricing.productName}</div>
                            <div class="text-sm text-white/60">${pricing.storeName}</div>
                            <div class="text-xs text-white/40 mt-1">Default: ${defaultPrice.toFixed(2)} DHS â€¢ Custom: ${pricing.customPrice.toFixed(2)} DHS</div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="text-right">
                                <div class="text-2xl font-black text-premium">${pricing.customPrice.toFixed(2)} DHS</div>
                                <div class="text-xs ${diffColor} font-medium">${diffText} DHS</div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <button onclick="editPricing(${pricing.id})" class="text-blue-400 hover:text-blue-300 font-medium">Edit</button>
                                <button onclick="deletePricing(${pricing.id})" class="text-red-400 hover:text-red-300 font-medium">Remove</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Function to get the effective price for a product at a store
        function getProductPrice(productName, storeName) {
            const customPricing = storePricingData.find(p => 
                p.productName === productName && p.storeName === storeName
            );
            
            if (customPricing) {
                return customPricing.customPrice;
            }
            
            const defaultProduct = productsData.find(p => p.name === productName);
            return defaultProduct ? defaultProduct.price : 0;
        }
        
        // Update product price when store or product changes
        function updateProductPrice() {
            const storeName = document.getElementById('storeName').value;
            const productName = document.getElementById('product').value;
            const unitPriceInput = document.getElementById('unitPrice');
            
            if (storeName && productName) {
                const price = getProductPrice(productName, storeName);
                unitPriceInput.value = price.toFixed(2);
                updateTotalAmount();
            } else {
                unitPriceInput.value = '';
                document.getElementById('amount').value = '';
            }
        }
        
        // Update total amount when quantity changes
        function updateTotalAmount() {
            const quantity = parseInt(document.getElementById('quantity').value) || 0;
            const unitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;
            const totalAmount = quantity * unitPrice;
            
            document.getElementById('amount').value = totalAmount.toFixed(2);
        }
        
        // Function to refresh the current sales form price if it's visible
        function refreshCurrentSalesFormPrice() {
            console.log('Refreshing sales form price...');
            
            const salesPage = document.getElementById('salesPage');
            if (!salesPage || salesPage.classList.contains('hidden')) {
                console.log('Sales form not visible, skipping refresh');
                return; // Sales form is not currently visible
            }
            
            const storeSelect = document.getElementById('storeName');
            const productSelect = document.getElementById('product');
            const unitPriceInput = document.getElementById('unitPrice');
            
            console.log('Store:', storeSelect?.value, 'Product:', productSelect?.value);
            
            if (storeSelect && productSelect && unitPriceInput && storeSelect.value && productSelect.value) {
                console.log('Updating price for:', productSelect.value, 'at', storeSelect.value);
                
                // Get the new price
                const newPrice = getProductPrice(productSelect.value, storeSelect.value);
                console.log('New price:', newPrice);
                
                // Update the unit price field
                unitPriceInput.value = newPrice.toFixed(2);
                
                // Update total amount
                updateTotalAmount();
                
                console.log('Price updated successfully');
            } else {
                console.log('Missing required elements or values for price update');
            }
        }

        // Sales Report Functions
        function showSalesReportPage() {
            document.getElementById('adminPage').classList.add('hidden');
            document.getElementById('salesReportPage').classList.remove('hidden');
            
            // Set default date range (last 30 days)
            const today = new Date();
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 30);
            
            document.getElementById('reportFromDate').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('reportToDate').value = today.toISOString().split('T')[0];
        }

        function generateReport() {
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;
            const reportType = document.getElementById('reportType').value;
            
            if (!fromDate || !toDate) {
                showCustomAlert('Please select both from and to dates.');
                return;
            }
            
            if (new Date(fromDate) > new Date(toDate)) {
                showCustomAlert('From date cannot be later than to date.');
                return;
            }
            
            // Filter sales data by date range
            const filteredSales = salesData.filter(sale => {
                const saleDate = new Date(sale.date);
                const from = new Date(fromDate);
                const to = new Date(toDate);
                return saleDate >= from && saleDate <= to;
            });
            
            if (filteredSales.length === 0) {
                showCustomAlert('No sales found for the selected date range.');
                return;
            }
            
            // Generate report based on type
            let reportData = [];
            let headers = [];
            
            switch (reportType) {
                case 'all':
                    reportData = filteredSales;
                    headers = ['Date', 'Store', 'Product', 'Employee', 'Quantity', 'Amount (DHS)'];
                    break;
                case 'product':
                    reportData = generateProductWiseReport(filteredSales);
                    headers = ['Product', 'Total Sales', 'Total Quantity', 'Total Revenue (DHS)', 'Avg Sale (DHS)'];
                    break;
                case 'store':
                    reportData = generateStoreWiseReport(filteredSales);
                    headers = ['Store', 'Total Sales', 'Total Quantity', 'Total Revenue (DHS)', 'Avg Sale (DHS)'];
                    break;
                case 'employee':
                    reportData = generateEmployeeWiseReport(filteredSales);
                    headers = ['Employee', 'Total Sales', 'Total Quantity', 'Total Revenue (DHS)', 'Avg Sale (DHS)'];
                    break;
            }
            
            // Store current report data for export
            window.currentReportData = { data: reportData, headers: headers, type: reportType, fromDate, toDate };
            
            // Update summary
            updateReportSummary(filteredSales);
            
            // Hide initial message and display report
            document.getElementById('reportInitialMessage').classList.add('hidden');
            displayReport(reportData, headers);
        }

        function generateProductWiseReport(sales) {
            const productMap = {};
            
            sales.forEach(sale => {
                if (!productMap[sale.product]) {
                    productMap[sale.product] = {
                        product: sale.product,
                        totalSales: 0,
                        totalQuantity: 0,
                        totalRevenue: 0
                    };
                }
                
                productMap[sale.product].totalSales++;
                productMap[sale.product].totalQuantity += sale.quantity;
                productMap[sale.product].totalRevenue += sale.amount;
            });
            
            return Object.values(productMap).map(item => ({
                ...item,
                avgSale: item.totalRevenue / item.totalSales
            }));
        }

        function generateStoreWiseReport(sales) {
            const storeMap = {};
            
            sales.forEach(sale => {
                if (!storeMap[sale.storeName]) {
                    storeMap[sale.storeName] = {
                        store: sale.storeName,
                        totalSales: 0,
                        totalQuantity: 0,
                        totalRevenue: 0
                    };
                }
                
                storeMap[sale.storeName].totalSales++;
                storeMap[sale.storeName].totalQuantity += sale.quantity;
                storeMap[sale.storeName].totalRevenue += sale.amount;
            });
            
            return Object.values(storeMap).map(item => ({
                ...item,
                avgSale: item.totalRevenue / item.totalSales
            }));
        }

        function generateEmployeeWiseReport(sales) {
            const employeeMap = {};
            
            sales.forEach(sale => {
                if (!employeeMap[sale.employeeName]) {
                    employeeMap[sale.employeeName] = {
                        employee: sale.employeeName,
                        totalSales: 0,
                        totalQuantity: 0,
                        totalRevenue: 0
                    };
                }
                
                employeeMap[sale.employeeName].totalSales++;
                employeeMap[sale.employeeName].totalQuantity += sale.quantity;
                employeeMap[sale.employeeName].totalRevenue += sale.amount;
            });
            
            return Object.values(employeeMap).map(item => ({
                ...item,
                avgSale: item.totalRevenue / item.totalSales
            }));
        }

        function updateReportSummary(sales) {
            const totalSales = sales.length;
            const totalRevenue = sales.reduce((sum, sale) => sum + sale.amount, 0);
            const totalQuantity = sales.reduce((sum, sale) => sum + sale.quantity, 0);
            const avgSale = totalSales > 0 ? totalRevenue / totalSales : 0;
            
            document.getElementById('summaryTotalSales').textContent = totalSales;
            document.getElementById('summaryTotalRevenue').textContent = `${totalRevenue.toFixed(2)} DHS`;
            document.getElementById('summaryTotalQty').textContent = totalQuantity;
            document.getElementById('summaryAvgSale').textContent = `${avgSale.toFixed(2)} DHS`;
            
            document.getElementById('reportSummary').classList.remove('hidden');
        }

        function displayReport(data, headers) {
            const headerRow = document.getElementById('reportTableHeader');
            const bodyDiv = document.getElementById('reportTableBody');
            
            // Create headers
            headerRow.innerHTML = headers.map(header => 
                `<th class="text-left py-4 px-6 font-bold text-white/90">${header}</th>`
            ).join('');
            
            // Create rows
            bodyDiv.innerHTML = data.map(row => {
                let cells = '';
                
                if (window.currentReportData.type === 'all') {
                    cells = `
                        <td class="py-4 px-6">${formatDate(row.date)}</td>
                        <td class="py-4 px-6">${row.storeName}</td>
                        <td class="py-4 px-6">${row.product}</td>
                        <td class="py-4 px-6">${row.employeeName}</td>
                        <td class="py-4 px-6">${row.quantity}</td>
                        <td class="py-4 px-6 font-bold text-premium">${row.amount.toFixed(2)}</td>
                    `;
                } else if (window.currentReportData.type === 'product') {
                    cells = `
                        <td class="py-4 px-6 font-bold">${row.product}</td>
                        <td class="py-4 px-6">${row.totalSales}</td>
                        <td class="py-4 px-6">${row.totalQuantity}</td>
                        <td class="py-4 px-6 font-bold text-premium">${row.totalRevenue.toFixed(2)}</td>
                        <td class="py-4 px-6">${row.avgSale.toFixed(2)}</td>
                    `;
                } else if (window.currentReportData.type === 'store') {
                    cells = `
                        <td class="py-4 px-6 font-bold">${row.store}</td>
                        <td class="py-4 px-6">${row.totalSales}</td>
                        <td class="py-4 px-6">${row.totalQuantity}</td>
                        <td class="py-4 px-6 font-bold text-premium">${row.totalRevenue.toFixed(2)}</td>
                        <td class="py-4 px-6">${row.avgSale.toFixed(2)}</td>
                    `;
                } else if (window.currentReportData.type === 'employee') {
                    cells = `
                        <td class="py-4 px-6 font-bold">${row.employee}</td>
                        <td class="py-4 px-6">${row.totalSales}</td>
                        <td class="py-4 px-6">${row.totalQuantity}</td>
                        <td class="py-4 px-6 font-bold text-premium">${row.totalRevenue.toFixed(2)}</td>
                        <td class="py-4 px-6">${row.avgSale.toFixed(2)}</td>
                    `;
                }
                
                return `<tr class="hover:bg-white/5 transition-all">${cells}</tr>`;
            }).join('');
            
            document.getElementById('reportResults').classList.remove('hidden');
        }

        function downloadReportCSV() {
            if (!window.currentReportData) {
                showCustomAlert('Please generate a report first.');
                return;
            }
            
            const { data, headers, type, fromDate, toDate } = window.currentReportData;
            
            let csvContent = headers.join(',') + '\n';
            
            data.forEach(row => {
                let csvRow = '';
                if (type === 'all') {
                    csvRow = `${row.date},${row.storeName},${row.product},${row.employeeName},${row.quantity},${row.amount.toFixed(2)}`;
                } else if (type === 'product') {
                    csvRow = `${row.product},${row.totalSales},${row.totalQuantity},${row.totalRevenue.toFixed(2)},${row.avgSale.toFixed(2)}`;
                } else if (type === 'store') {
                    csvRow = `${row.store},${row.totalSales},${row.totalQuantity},${row.totalRevenue.toFixed(2)},${row.avgSale.toFixed(2)}`;
                } else if (type === 'employee') {
                    csvRow = `${row.employee},${row.totalSales},${row.totalQuantity},${row.totalRevenue.toFixed(2)},${row.avgSale.toFixed(2)}`;
                }
                csvContent += csvRow + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `sales_report_${type}_${fromDate}_to_${toDate}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccessMessage('CSV report downloaded successfully!');
        }

        function downloadReportPDF() {
            if (!window.currentReportData) {
                showCustomAlert('Please generate a report first.');
                return;
            }
            
            const { data, headers, type, fromDate, toDate } = window.currentReportData;
            
            // Create a simple HTML table for PDF generation
            let htmlContent = `
                <html>
                <head>
                    <title>Sales Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #333; text-align: center; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        .summary { margin-bottom: 20px; padding: 10px; background-color: #f9f9f9; }
                    </style>
                </head>
                <body>
                    <h1>EDEN Sales Report</h1>
                    <div class="summary">
                        <p><strong>Report Type:</strong> ${type.charAt(0).toUpperCase() + type.slice(1)} Wise</p>
                        <p><strong>Date Range:</strong> ${fromDate} to ${toDate}</p>
                        <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach(row => {
                htmlContent += '<tr>';
                if (type === 'all') {
                    htmlContent += `<td>${row.date}</td><td>${row.storeName}</td><td>${row.product}</td><td>${row.employeeName}</td><td>${row.quantity}</td><td>${row.amount.toFixed(2)} DHS</td>`;
                } else if (type === 'product') {
                    htmlContent += `<td>${row.product}</td><td>${row.totalSales}</td><td>${row.totalQuantity}</td><td>${row.totalRevenue.toFixed(2)} DHS</td><td>${row.avgSale.toFixed(2)} DHS</td>`;
                } else if (type === 'store') {
                    htmlContent += `<td>${row.store}</td><td>${row.totalSales}</td><td>${row.totalQuantity}</td><td>${row.totalRevenue.toFixed(2)} DHS</td><td>${row.avgSale.toFixed(2)} DHS</td>`;
                } else if (type === 'employee') {
                    htmlContent += `<td>${row.employee}</td><td>${row.totalSales}</td><td>${row.totalQuantity}</td><td>${row.totalRevenue.toFixed(2)} DHS</td><td>${row.avgSale.toFixed(2)} DHS</td>`;
                }
                htmlContent += '</tr>';
            });
            
            htmlContent += `
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            
            // Open in new window for printing/saving as PDF
            const printWindow = window.open('', '_blank');
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
            }, 500);
            
            showSuccessMessage('PDF report opened in new window. Use browser print to save as PDF.');
        }

        function downloadMasterData() {
            // Compile all data
            const masterData = {
                sales: salesData,
                products: productsData,
                stores: storesData,
                employees: employeesData,
                storePricing: storePricingData,
                exportDate: new Date().toISOString(),
                exportedBy: currentUser.name
            };
            
            // Convert to CSV format
            let csvContent = 'EDEN MASTER DATA EXPORT\n';
            csvContent += `Export Date: ${new Date().toLocaleString()}\n`;
            csvContent += `Exported By: ${currentUser.name}\n\n`;
            
            // Sales Data
            csvContent += 'SALES DATA\n';
            csvContent += 'ID,Date,Store,Product,Employee,Quantity,Amount\n';
            salesData.forEach(sale => {
                csvContent += `${sale.id},${sale.date},${sale.storeName},${sale.product},${sale.employeeName},${sale.quantity},${sale.amount}\n`;
            });
            
            csvContent += '\nPRODUCTS DATA\n';
            csvContent += 'ID,Name,Price\n';
            productsData.forEach(product => {
                csvContent += `${product.id},${product.name},${product.price}\n`;
            });
            
            csvContent += '\nSTORES DATA\n';
            csvContent += 'ID,Name,Location,Description,Status\n';
            storesData.forEach(store => {
                csvContent += `${store.id},${store.name},${store.location},${store.description || ''},${store.status}\n`;
            });
            
            csvContent += '\nEMPLOYEES DATA\n';
            csvContent += 'ID,Username,Name,Role,Status\n';
            employeesData.forEach(employee => {
                csvContent += `${employee.id},${employee.username},${employee.name},${employee.role},${employee.status}\n`;
            });
            
            csvContent += '\nSTORE PRICING DATA\n';
            csvContent += 'ID,Product,Store,Custom Price\n';
            storePricingData.forEach(pricing => {
                csvContent += `${pricing.id},${pricing.productName},${pricing.storeName},${pricing.customPrice}\n`;
            });
            
            // Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset-utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `eden_master_data_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccessMessage('Master data exported successfully!');
        }

        function downloadSystemBackup() {
            // Create comprehensive system backup
            const backupData = {
                systemInfo: {
                    name: 'EDEN Sales Platform',
                    version: '1.0.0',
                    backupDate: new Date().toISOString(),
                    backupBy: currentUser.name,
                    totalSales: salesData.length,
                    totalRevenue: salesData.reduce((sum, sale) => sum + sale.amount, 0)
                },
                data: {
                    sales: salesData,
                    products: productsData,
                    stores: storesData,
                    employees: employeesData,
                    storePricing: storePricingData,
                    demoUsers: demoUsers
                },
                settings: {
                    lastBackup: new Date().toISOString(),
                    dataIntegrity: 'verified'
                }
            };
            
            // Create JSON backup file
            const jsonContent = JSON.stringify(backupData, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
            link.setAttribute('href', url);
            link.setAttribute('download', `eden_system_backup_${timestamp}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccessMessage('System backup downloaded successfully!');
        }

        // Smart Sync Data Function - Intelligently sync data without duplicates
        async function quickStoreData() {
            if (!isFirebaseConfigured) {
                showCustomAlert('Firebase is not configured. Cannot sync data to cloud.');
                return;
            }
            
            console.log('ðŸ§  Starting Smart Sync Data...');
            updateSyncStatus('syncing');
            
            // Show sync progress notification
            const syncNotification = document.createElement('div');
            syncNotification.id = 'syncNotification';
            syncNotification.className = 'fixed top-6 right-6 bg-purple-500/20 border border-purple-500/30 text-purple-300 px-6 py-4 rounded-2xl text-sm backdrop-blur-sm z-50 fade-in';
            syncNotification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <svg class="animate-spin w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <div>
                        <div class="font-bold">Smart Sync Data</div>
                        <div class="text-xs opacity-80" id="syncProgress">Analyzing data...</div>
                    </div>
                </div>
            `;
            document.body.appendChild(syncNotification);
            
            const updateProgress = (message) => {
                const progressDiv = document.getElementById('syncProgress');
                if (progressDiv) progressDiv.textContent = message;
            };
            
            try {
                let syncResults = {
                    sales: { updated: 0, created: 0, failed: 0 },
                    products: { updated: 0, created: 0, failed: 0 },
                    stores: { updated: 0, created: 0, failed: 0 },
                    employees: { updated: 0, created: 0, failed: 0 },
                    pricing: { updated: 0, created: 0, failed: 0 },
                    users: { updated: 0, created: 0, failed: 0 }
                };
                
                // Smart sync function for each data type
                const smartSyncToFirebase = async (localData, firebasePath, idField = 'id') => {
                    updateProgress(`Smart syncing ${firebasePath}...`);
                    console.log(`ðŸ§  Smart syncing ${firebasePath}...`);
                    
                    // Get existing Firebase data
                    const firebaseSnapshot = await database.ref(firebasePath).once('value');
                    const firebaseData = firebaseSnapshot.val() || {};
                    
                    // Create maps for efficient lookup
                    const firebaseByLocalId = {};
                    Object.keys(firebaseData).forEach(firebaseKey => {
                        const item = firebaseData[firebaseKey];
                        if (item[idField]) {
                            firebaseByLocalId[item[idField]] = { ...item, firebaseKey };
                        }
                    });
                    
                    // Process each local item
                    for (const localItem of localData) {
                        try {
                            const localId = localItem[idField];
                            const existingFirebaseItem = firebaseByLocalId[localId];
                            
                            if (existingFirebaseItem) {
                                // Update existing item
                                const updatedItem = {
                                    ...localItem,
                                    lastUpdated: new Date().toISOString()
                                };
                                await database.ref(`${firebasePath}/${existingFirebaseItem.firebaseKey}`).set(updatedItem);
                                localItem.firebaseKey = existingFirebaseItem.firebaseKey;
                                syncResults[firebasePath.split('/')[0]].updated++;
                                console.log(`âœ… Updated ${firebasePath} item:`, localId);
                            } else {
                                // Create new item
                                const newItem = {
                                    ...localItem,
                                    createdAt: new Date().toISOString(),
                                    lastUpdated: new Date().toISOString()
                                };
                                const ref = await database.ref(firebasePath).push(newItem);
                                localItem.firebaseKey = ref.key;
                                syncResults[firebasePath.split('/')[0]].created++;
                                console.log(`âœ… Created ${firebasePath} item:`, localId);
                            }
                        } catch (error) {
                            console.error(`âŒ Failed to sync ${firebasePath} item:`, localItem[idField], error);
                            syncResults[firebasePath.split('/')[0]].failed++;
                        }
                    }
                };
                
                // Smart sync all data collections
                await smartSyncToFirebase(salesData, 'sales', 'id');
                await smartSyncToFirebase(productsData, 'products', 'id');
                await smartSyncToFirebase(storesData, 'stores', 'id');
                await smartSyncToFirebase(employeesData, 'employees', 'id');
                await smartSyncToFirebase(storePricingData, 'storePricing', 'id');
                
                // Handle users separately (keyed by username)
                updateProgress('Smart syncing users...');
                console.log('ðŸ§  Smart syncing users...');
                
                for (const [username, userData] of Object.entries(demoUsers)) {
                    try {
                        const userSnapshot = await database.ref(`users/${username}`).once('value');
                        const existingUser = userSnapshot.val();
                        
                        if (existingUser) {
                            // Update existing user - preserve password if not provided
                            const updatedUser = {
                                ...existingUser, // Keep existing data including password
                                ...userData, // Override with new data
                                lastUpdated: new Date().toISOString()
                            };
                            // Ensure password is always included
                            if (!updatedUser.password && userData.password) {
                                updatedUser.password = userData.password;
                            }
                            await database.ref(`users/${username}`).set(updatedUser);
                            syncResults.users.updated++;
                            console.log(`âœ… Updated user with password:`, username);
                        } else {
                            // Create new user
                            const newUser = {
                                ...userData,
                                createdAt: new Date().toISOString(),
                                lastUpdated: new Date().toISOString()
                            };
                            // Ensure password is included
                            if (!newUser.password) {
                                console.warn(`âš ï¸ User ${username} missing password, using default`);
                                newUser.password = 'password123'; // Default password
                            }
                            await database.ref(`users/${username}`).set(newUser);
                            syncResults.users.created++;
                            console.log(`âœ… Created user with password:`, username);
                        }
                    } catch (error) {
                        console.error(`âŒ Failed to sync user:`, username, error);
                        syncResults.users.failed++;
                    }
                }
                
                // Update local storage with Firebase keys
                localStorage.setItem('edenSalesData', JSON.stringify(salesData));
                localStorage.setItem('edenProductsData', JSON.stringify(productsData));
                localStorage.setItem('edenStoresData', JSON.stringify(storesData));
                localStorage.setItem('edenEmployeesData', JSON.stringify(employeesData));
                localStorage.setItem('edenStorePricingData', JSON.stringify(storePricingData));
                
                // Calculate totals
                const totalUpdated = Object.values(syncResults).reduce((sum, result) => sum + result.updated, 0);
                const totalCreated = Object.values(syncResults).reduce((sum, result) => sum + result.created, 0);
                const totalFailed = Object.values(syncResults).reduce((sum, result) => sum + result.failed, 0);
                
                console.log('âœ… Smart Sync completed!', syncResults);
                
                // Update sync notification with results
                syncNotification.className = 'fixed top-6 right-6 bg-green-500/20 border border-green-500/30 text-green-300 px-6 py-4 rounded-2xl text-sm backdrop-blur-sm z-50 fade-in';
                syncNotification.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <div>
                            <div class="font-bold">Smart Sync Complete!</div>
                            <div class="text-xs opacity-80">
                                ðŸ”„ ${totalUpdated} updated â€¢ âž• ${totalCreated} created
                                ${totalFailed > 0 ? ` â€¢ âŒ ${totalFailed} failed` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                updateSyncStatus('synced');
                
                // Refresh data from Firebase to ensure UI is up-to-date
                updateProgress('Refreshing data...');
                await loadFirebaseData();
                        populateSelectsRealtime();
                
                // Update UI components
                if (currentUser) {
                    if (currentUser.role === 'admin') {
                        updateAdminStats();
                        updateEmployeesList();
                        updateStoresList();
                        updatePricingList();
                    } else {
                        updateSalesStats();
                        updateRecentSales();
                    }
                }
                
                // Remove notification after delay
                setTimeout(() => {
                    if (syncNotification && syncNotification.parentNode) {
                        syncNotification.remove();
                    }
                }, 5000);
                
            } catch (error) {
                console.error('âŒ Smart Sync failed:', error);
                
                // Update notification with error
                syncNotification.className = 'fixed top-6 right-6 bg-red-500/20 border border-red-500/30 text-red-300 px-6 py-4 rounded-2xl text-sm backdrop-blur-sm z-50 fade-in';
                syncNotification.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        <div>
                            <div class="font-bold">Smart Sync Failed</div>
                            <div class="text-xs opacity-80">${error.message}</div>
                        </div>
                    </div>
                `;
                
                updateSyncStatus('error');
                
                // Remove notification after delay
                setTimeout(() => {
                    if (syncNotification && syncNotification.parentNode) {
                        syncNotification.remove();
                    }
                }, 8000);
            }
        }

        // Auto-refresh current page data
        function refreshCurrentPageData() {
            if (!currentUser) return;
            
            try {
                if (currentUser.role === 'admin') {
                    // Admin page is visible
                    if (!document.getElementById('adminPage').classList.contains('hidden')) {
                        updateAdminStats();
                        updateEmployeesList();
                        updateStoresList();
                        updatePricingList();
                    }
                    // Sales report page is visible
                    else if (!document.getElementById('salesReportPage').classList.contains('hidden')) {
                        // Don't auto-refresh reports as they are user-generated
                    }
                    // Products page is visible
                    else if (!document.getElementById('productsPage').classList.contains('hidden')) {
                        updateProductsList();
                    }
                } else {
                    // Employee sales page is visible
                    if (!document.getElementById('salesPage').classList.contains('hidden')) {
                        updateSalesStats();
                        updateRecentSales();
                    }
                }
            } catch (error) {
                console.warn('Auto-refresh error:', error);
            }
        }

        
async function mirrorSyncAllData() {
    if (!isFirebaseConfigured) {
        showCustomAlert('Firebase is not configured. Cannot sync data to cloud.');
        return;
    }
    updateSyncStatus('syncing');
    const notify = document.createElement('div');
    notify.id = 'mirrorSyncNote';
    notify.className = 'fixed top-6 right-6 bg-blue-500/20 border border-blue-500/30 text-blue-300 px-6 py-4 rounded-2xl text-sm backdrop-blur-sm z-50 fade-in';
    notify.innerHTML = '<div class="font-bold">Mirror Sync</div><div class="text-xs opacity-80">Fetching from DB...</div>';
    document.body.appendChild(notify);
    const setMsg = (m)=>{ const d = notify.querySelector('div:nth-child(2)'); if(d) d.textContent = m; };

    try {
        // 1) Pull all remote data -> replace local
        const [salesSnap, productsSnap, storesSnap, employeesSnap, pricingSnap, usersSnap] = await Promise.all([
            database.ref('sales').once('value'),
            database.ref('products').once('value'),
            database.ref('stores').once('value'),
            database.ref('employees').once('value'),
            database.ref('storePricing').once('value'),
            database.ref('users').once('value')
        ]);

        const valOrEmpty = s => s && s.exists() ? s.val() : {};
        const remoteSales = valOrEmpty(salesSnap);
        const remoteProducts = valOrEmpty(productsSnap);
        const remoteStores = valOrEmpty(storesSnap);
        const remoteEmployees = valOrEmpty(employeesSnap);
        const remotePricing = valOrEmpty(pricingSnap);
        const remoteUsers = valOrEmpty(usersSnap);

        // Normalize into arrays with firebaseKey
        const mapObj = (obj) => Object.keys(obj).map(k => ({ ...obj[k], firebaseKey: k }));

        salesData = mapObj(remoteSales);
        productsData = mapObj(remoteProducts);
        storesData = mapObj(remoteStores);
        employeesData = mapObj(remoteEmployees);
        storePricingData = mapObj(remotePricing);
        // Users remain keyed by username
        Object.keys(remoteUsers).forEach(u => { demoUsers[u] = { ...remoteUsers[u], firebaseKey: u }; });

        // Persist
        localStorage.setItem('edenSalesData', JSON.stringify(salesData));
        localStorage.setItem('edenProductsData', JSON.stringify(productsData));
        localStorage.setItem('edenStoresData', JSON.stringify(storesData));
        localStorage.setItem('edenEmployeesData', JSON.stringify(employeesData));
        localStorage.setItem('edenStorePricingData', JSON.stringify(storePricingData));

        // Update UI
        refreshCurrentPageData();

        setMsg('Pushing app data back to DB (mirror)...');

        // 2) Push back to DB using deterministic keys (so DB == App)
        // Sales: keep existing deterministic key if present; else make one
        await database.ref('sales').set({}); // clear
        for (const sale of salesData) {
            const key = sale.firebaseKey || `${sale.employeeId || 'emp'}_${sale.date || 'date'}_${sale.product || 'prod'}_${Math.floor(Date.now()/5000)}`;
            await database.ref('sales').child(key).set(sale);
        }

        // Products: use product name as key
        await database.ref('products').set({});
        for (const p of productsData) {
            const key = (p.name || p.productName || `prod_${Math.random().toString(36).slice(2,8)}`).replace(/[.#$\[\]]/g,'_');
            await database.ref('products').child(((product.name || product.productName) || `prod_${Math.random().toString(36).slice(2,8)}`).replace(/[.#$\[\]]/g,'_')).set(product);
        }

        // Stores: use store name as key
        await database.ref('stores').set({});
        for (const s of storesData) {
            const key = (s.name || s.storeName || `store_${Math.random().toString(36).slice(2,8)}`).replace(/[.#$\[\]]/g,'_');
            await database.ref('stores').child(((store.name || store.storeName) || `store_${Math.random().toString(36).slice(2,8)}`).replace(/[.#$\[\]]/g,'_')).set(store);
        }

        // Employees: use username as key
        await database.ref('employees').set({});
        for (const e of employeesData) {
            const key = (e.username || `emp_${Math.random().toString(36).slice(2,8)}`).replace(/[.#$\[\]]/g,'_');
            await database.ref('employees').child((employee.username || `emp_${Math.random().toString(36).slice(2,8)}`).replace(/[.#$\[\]]/g,'_')).set(employee);
        }

        // Store Pricing: composite key store_product
        await database.ref('storePricing').set({});
        for (const pr of storePricingData) {
            const key = `${(pr.storeName||'store').replace(/[.#$\[\]]/g,'_')}__${(pr.productName||'product').replace(/[.#$\[\]]/g,'_')}`;
            await database.ref('storePricing').child(`${(pricing.storeName||'store').replace(/[.#$\[\]]/g,'_')}__${(pricing.productName||'product').replace(/[.#$\[\]]/g,'_')}`).set(pricing);
        }

        // Users: stay keyed by username
        await database.ref('users').set({});
        for (const [username, userData] of Object.entries(demoUsers)) {
            const safe = username.replace(/[.#$\[\]]/g,'_');
            await database.ref('users').child(safe).set(userData);
        }

        notify.className = 'fixed top-6 right-6 bg-green-500/20 border border-green-500/30 text-green-300 px-6 py-4 rounded-2xl text-sm backdrop-blur-sm z-50 fade-in';
        setMsg('Mirror sync completed. DB and App are identical now.');
        setTimeout(()=> notify.remove(), 4000);
        updateSyncStatus('synced');
        refreshCurrentPageData();
    } catch (e) {
        console.error('Mirror sync failed:', e);
        notify.className = 'fixed top-6 right-6 bg-red-500/20 border border-red-500/30 text-red-300 px-6 py-4 rounded-2xl text-sm backdrop-blur-sm z-50 fade-in';
        const d = notify.querySelector('div:nth-child(2)'); if (d) d.textContent = e.message || 'Failed';
        updateSyncStatus('error');
        setTimeout(()=> notify.remove(), 7000);
    }
}


// Quick Sync All Data Function
        async function quickSyncAllData() {
            if (!isFirebaseConfigured) {
                showCustomAlert('Firebase is not configured. Cannot sync data to cloud.');
                return;
            }
            
            console.log('ðŸ”„ Starting quick sync of all data...');
            updateSyncStatus('syncing');
            
            // Show sync progress notification
            const syncNotification = document.createElement('div');
            syncNotification.id = 'syncNotification';
            syncNotification.className = 'fixed top-6 right-6 bg-blue-500/20 border border-blue-500/30 text-blue-300 px-6 py-4 rounded-2xl text-sm backdrop-blur-sm z-50 fade-in';
            syncNotification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <svg class="animate-spin w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <div>
                        <div class="font-bold">Syncing All Data...</div>
                        <div class="text-xs opacity-80" id="syncProgress">Preparing sync...</div>
                    </div>
                </div>
            `;
            document.body.appendChild(syncNotification);
            
            const updateProgress = (message) => {
                const progressDiv = document.getElementById('syncProgress');
                if (progressDiv) progressDiv.textContent = message;
            };
            
            try {
                let syncResults = {
                    sales: { success: 0, failed: 0 },
                    products: { success: 0, failed: 0 },
                    stores: { success: 0, failed: 0 },
                    employees: { success: 0, failed: 0 },
                    pricing: { success: 0, failed: 0 },
                    users: { success: 0, failed: 0 }
                };
                
                // 1. Sync Sales Data
                updateProgress('Syncing sales data...');
                console.log('ðŸ“Š Syncing sales data...');
                
                // Clear existing sales data in Firebase and re-upload all
                await database.ref('sales').remove();
                for (const sale of salesData) {
                    try {
                        await database.ref('sales').child(`${sale.employeeId}_${sale.date}_${sale.product}_${Math.floor(Date.now()/5000)}`).set(sale);
                        syncResults.sales.success++;
                    } catch (error) {
                        console.error('Failed to sync sale:', sale.id, error);
                        syncResults.sales.failed++;
                    }
                }
                
                // 2. Sync Products Data
                updateProgress('Syncing products data...');
                console.log('ðŸ“¦ Syncing products data...');
                
                await database.ref('products').remove();
                for (const product of productsData) {
                    try {
                        await database.ref('products').child((((product.name || product.productName) || `prod_${Math.random().toString(36).slice(2,8)}`).replace(/[.#$\[\]]/g,'_'))).set(product);
                        syncResults.products.success++;
                    } catch (error) {
                        console.error('Failed to sync product:', product.id, error);
                        syncResults.products.failed++;
                    }
                }
                
                // 3. Sync Stores Data
                updateProgress('Syncing stores data...');
                console.log('ðŸª Syncing stores data...');
                
                await database.ref('stores').remove();
                for (const store of storesData) {
                    try {
                        await database.ref('stores').child((((store.name || store.storeName) || `store_${Math.random().toString(36).slice(2,8)}`).replace(/[.#$\[\]]/g,'_'))).set(store);
                        syncResults.stores.success++;
                    } catch (error) {
                        console.error('Failed to sync store:', store.id, error);
                        syncResults.stores.failed++;
                    }
                }
                
                // 4. Sync Employees Data
                updateProgress('Syncing employees data...');
                console.log('ðŸ‘¥ Syncing employees data...');
                
                await database.ref('employees').remove();
                for (const employee of employeesData) {
                    try {
                        await database.ref('employees').child(((employee.username || `emp_${Math.random().toString(36).slice(2,8)}`).replace(/[.#$\[\]]/g,'_'))).set(employee);
                        syncResults.employees.success++;
                    } catch (error) {
                        console.error('Failed to sync employee:', employee.id, error);
                        syncResults.employees.failed++;
                    }
                }
                
                // 5. Sync Store Pricing Data
                updateProgress('Syncing pricing data...');
                console.log('ðŸ’° Syncing pricing data...');
                
                await database.ref('storePricing').remove();
                for (const pricing of storePricingData) {
                    try {
                        await database.ref('storePricing').child(`${(pricing.storeName||'store').replace(/[.#$\[\]]/g,'_')}__${(pricing.productName||'product').replace(/[.#$\[\]]/g,'_')}`).set(pricing);
                        syncResults.pricing.success++;
                    } catch (error) {
                        console.error('Failed to sync pricing:', pricing.id, error);
                        syncResults.pricing.failed++;
                    }
                }
                
                // 6. Sync Users Data
                updateProgress('Syncing users data...');
                console.log('ðŸ‘¤ Syncing users data...');
                
                await database.ref('users').remove();
                for (const [username, userData] of Object.entries(demoUsers)) {
                    try {
                        await database.ref(`users/${username}`).set(userData);
                        syncResults.users.success++;
                    } catch (error) {
                        console.error('Failed to sync user:', username, error);
                        syncResults.users.failed++;
                    }
                }
                
                // Calculate totals
                const totalSuccess = Object.values(syncResults).reduce((sum, result) => sum + result.success, 0);
                const totalFailed = Object.values(syncResults).reduce((sum, result) => sum + result.failed, 0);
                
                console.log('âœ… Quick sync completed!', syncResults);
                
                // Update sync notification with results
                syncNotification.className = 'fixed top-6 right-6 bg-green-500/20 border border-green-500/30 text-green-300 px-6 py-4 rounded-2xl text-sm backdrop-blur-sm z-50 fade-in';
                syncNotification.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <div>
                            <div class="font-bold">Sync Completed!</div>
                            <div class="text-xs opacity-80">
                                âœ… ${totalSuccess} items synced successfully
                                ${totalFailed > 0 ? `â€¢ âŒ ${totalFailed} failed` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                updateSyncStatus('synced');
                
                // Update all UI components
                if (currentUser) {
                    if (currentUser.role === 'admin') {
                        updateAdminStats();
                        updateEmployeesList();
                        updateStoresList();
                        updatePricingList();
                    } else {
                        updateSalesStats();
                        updateRecentSales();
                    }
                }
                
                // Remove notification after delay
                setTimeout(() => {
                    if (syncNotification && syncNotification.parentNode) {
                        syncNotification.remove();
                    }
                }, 5000);
                
            } catch (error) {
                console.error('âŒ Quick sync failed:', error);
                
                // Update notification with error
                syncNotification.className = 'fixed top-6 right-6 bg-red-500/20 border border-red-500/30 text-red-300 px-6 py-4 rounded-2xl text-sm backdrop-blur-sm z-50 fade-in';
                syncNotification.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        <div>
                            <div class="font-bold">Sync Failed</div>
                            <div class="text-xs opacity-80">${error.message}</div>
                        </div>
                    </div>
                `;
                
                updateSyncStatus('error');
                
                // Remove notification after delay
                setTimeout(() => {
                    if (syncNotification && syncNotification.parentNode) {
                        syncNotification.remove();
                    }
                }, 8000);
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96e81000921dd1e0',t:'MTc1NTA4NjUzNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
<script>
(function () {
  var isSimplifying = false;
  var observer = null;

  function simplifyEmployeeCard(card) {
    if (!card) return;
    // Remove any status chips if present
    card.querySelectorAll('.space-x-3 > span').forEach(function(s){ s.remove(); });
    // Keep only role (strip anything like "â€¢ Last active: ...")
    var roleDiv = card.querySelector('div > .text-sm.text-white\\/60');
    if (roleDiv) {
      var raw = roleDiv.textContent || '';
      if (raw.indexOf('â€¢') !== -1) { // only modify when needed
        roleDiv.textContent = raw.split('â€¢')[0].trim();
      }
    }
  }

  function simplifyAll() {
    if (isSimplifying) return;
    isSimplifying = true;
    if (observer) observer.disconnect();

    var list = document.getElementById('employeesList');
    if (list) {
      list.querySelectorAll('.flex.items-center.justify-between').forEach(simplifyEmployeeCard);
    }

    // reconnect observer after changes
    if (list) {
      if (!observer) {
        observer = new MutationObserver(function(){ simplifyAll(); });
      }
      observer.observe(list, { childList: true, subtree: true });
    }

    isSimplifying = false;
  }

  // Initial run and observe
  document.addEventListener('DOMContentLoaded', simplifyAll);
  // If DOMContentLoaded already fired in single-file apps, run immediately
  simplifyAll();
})();
</script>
</body>
</html>

<script>
// ===== Products CRUD (name + price) =====

// Simple router helpers (these likely already exist; if so, this won't harm)
function showProductsPage(){
  hideAllPages();
  document.getElementById('productsPage').classList.remove('hidden');
  loadProductsList();
}
function hideAllPages(){
  ['loginPage','salesPage','adminPage','salesReportPage','productsPage'].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.classList.add('hidden');
  });
}

// Open/close modal
function showAddProductModal(){
  const overlay = document.getElementById('productModalOverlay');
  const form = document.getElementById('productModalForm');
  document.getElementById('productModalTitle').textContent = 'Add Product';
  form.reset();
  form.onsubmit = async (e)=>{
    e.preventDefault();
    const fd = new FormData(form);
    const name = (fd.get('productName')||'').trim();
    const price = parseFloat(fd.get('price')||'0');
    if (!name || isNaN(price)) return;
    await addProduct({name, price});
    closeProductModal();
  };
  overlay.classList.remove('hidden');
}
function showEditProductModal(key, data){
  const overlay = document.getElementById('productModalOverlay');
  const form = document.getElementById('productModalForm');
  document.getElementById('productModalTitle').textContent = 'Edit Product';
  form.productName.value = data.name || '';
  form.price.value = data.price || 0;
  form.onsubmit = async (e)=>{
    e.preventDefault();
    const fd = new FormData(form);
    const name = (fd.get('productName')||'').trim();
    const price = parseFloat(fd.get('price')||'0');
    if (!name || isNaN(price)) return;
    await updateProduct(key, {name, price});
    closeProductModal();
  };
  overlay.classList.remove('hidden');
}
function closeProductModal(){
  const overlay = document.getElementById('productModalOverlay');
  if (overlay) overlay.classList.add('hidden');
}

// CRUD ops
async function addProduct(p){
  if (!window.database) throw new Error('DB not ready');
  const ref = await window.database.ref('products').push({
    name: p.name,
    price: p.price,
    createdAt: Date.now()
  });
  // refresh dropdown index and list
  if (window.productIndex) window.productIndex[p.name] = { key: ref.key, price: p.price };
  await loadProductsList();
}
async function updateProduct(key, p){
  await window.database.ref('products/'+key).set({
    name: p.name,
    price: p.price,
    updatedAt: Date.now()
  });
  await loadProductsList();
}
async function deleteProduct(key){
  if (!confirm('Delete this product?')) return;
  await window.database.ref('products/'+key).remove();
  await loadProductsList();
}

function renderProductsList(products){
  const list = document.getElementById('productsPageList');
  if (!list) return;
  if (!products.length){
    list.innerHTML = '<div class="text-white/50 text-center py-8 font-medium">No products yet</div>';
    return;
  }
  list.innerHTML = products.map(p=>{
    const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(p))));
    return `
      <div class="flex items-center justify-between p-6 bg-white/5 rounded-2xl border border-white/10 hover:bg-white/10 transition-all">
        <div>
          <div class="font-bold text-white text-lg">${p.name}</div>
          <div class="text-sm text-white/60">Price: ${Number(p.price||0).toFixed(2)} DHS</div>
        </div>
        <div class="flex items-center space-x-3">
          <button class="text-blue-400 hover:text-blue-300 font-medium" onclick="(function(){const d=JSON.parse(decodeURIComponent(escape(atob('${encoded}')))); showEditProductModal(d.firebaseKey||d.key, d);})()">Edit</button>
          <button class="text-red-400 hover:text-red-300 font-medium" onclick="deleteProduct('${p.firebaseKey||p.key}')">Delete</button>
        </div>
      </div>`;
  }).join('');
}

// Subscribe to list changes (live)
let _productsListenerAttached = false;
function loadProductsList(){
  if (!window.database) return;
  const ref = window.database.ref('products');
  if (!_productsListenerAttached){
    ref.on('value', snap=>{
      const arr = [];
      if (snap.exists()){
        const obj = snap.val();
        for (const [k,v] of Object.entries(obj)){
          arr.push({ ...(v||{}), firebaseKey: k });
        }
      }
      renderProductsList(arr);
    });
    _productsListenerAttached = true;
  } else {
    ref.once('value').then(snap=>{
      const arr = [];
      if (snap.exists()){
        const obj = snap.val();
        for (const [k,v] of Object.entries(obj)){
          arr.push({ ...(v||{}), firebaseKey: k });
        }
      }
      renderProductsList(arr);
    });
  }
}

// Hook product list load after initial Firebase sync too
window.addEventListener('load', ()=>{
  if (document.getElementById('productsPage')){
    // optional preload
  }
});
</script>
